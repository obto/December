/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* ----- DETAILED BASIC CONFIGURATION ----- */

var adPercent = 0.1;

var Favicon_URL = 'https://cdn.jsdelivr.net/gh/HappyHub1/December/Images/tiger.png';

var ChannelName_Caption = '25 Days of Autism';

var TitleBarDescription_Caption = '>Streaming:';

var ThemesCSS = [
];

var TopUserLogo = [
];

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* ----- END OF CONFIGURATION, DO NOT CHANGE ANYTHING BELOW ----- */

/* ----- Initial channel options ----- */

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* ----- POLYFILLS ------ */
(function() {
  var lastTime = 0;
  var vendors = ['ms', 'moz', 'webkit', 'o'];
  for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
      window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
      window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame']
                                 || window[vendors[x]+'CancelRequestAnimationFrame'];
  }

  if (!window.requestAnimationFrame)
      window.requestAnimationFrame = function(callback, element) {
          var currTime = new Date().getTime();
          var timeToCall = Math.max(0, 16 - (currTime - lastTime));
          var id = window.setTimeout(function() { callback(currTime + timeToCall); },
            timeToCall);
          lastTime = currTime + timeToCall;
          return id;
      };

  if (!window.cancelAnimationFrame)
      window.cancelAnimationFrame = function(id) {
          clearTimeout(id);
      };
}());

/* ----- getting channel options ----- */

var defplayer = "right";
var defuserlist = "left";
var defqueue = "right";

var UCONF = {
	"player":getOrDefault(CHANNEL.name + "_player", defplayer),
	"userlist":getOrDefault(CHANNEL.name + "_userlist", defuserlist),
	"queue":getOrDefault(CHANNEL.name + "_queue", defqueue),
	"qsize":getOrDefault(CHANNEL.name + "_qsize", "wide"),
	"main":getOrDefault(CHANNEL.name + "_main", "top"),
	"motd":getOrDefault(CHANNEL.name + "_motd", "top"),
	"logo":getOrDefault(CHANNEL.name + "_logo", "no"),
	"logourl":getOrDefault(CHANNEL.name + "_logourl", ""),
	"logoht":getOrDefault(CHANNEL.name + "_logoht", "200"),
	"header":getOrDefault(CHANNEL.name + "_header", "detached"),
	"css":getOrDefault(CHANNEL.name + "_css", "no"),
	"csscode":getOrDefault(CHANNEL.name + "_csscode", ""),
	"showname":getOrDefault(CHANNEL.name + "_showname", "no")
};
var USERTHEME = getOrDefault(CHANNEL.name + "_theme", "/css/themes/slate.css");
var USERVISITS = getOrDefault(CHANNEL.name + "_visits", 0);
var USERONLINE = 0;
var NOPLAYER = false;
var FULLPL = false;
var FLUID = getOrDefault(CHANNEL.name + "_FLUID", true);
var LAYOUTBOX = getOrDefault(CHANNEL.name + "_LAYOUTBOX", true);
var MINIMIZED = false;
var WEBKIT = "webkitRequestAnimationFrame" in window;
var MAXH = getOrDefault(CHANNEL.name + "_MAXH", "300");
var MAXW = getOrDefault(CHANNEL.name + "_MAXW", "300");
var HIDEHF = getOrDefault(CHANNEL.name + "_HIDEHF", false);
var HIDEPL = getOrDefault(CHANNEL.name + "_HIDEPL", false);
var HIDEANN = getOrDefault(CHANNEL.name + "_HIDEANN", false);
var HIDEMOTD = getOrDefault(CHANNEL.name + "_HIDEMOTD", false);
var CHATFUNC = false;
var CLEARING = false;
var ANTIAFK = false;
var ADDONESECOND = '';
var PLAYERHTML = '';
var PINGLINK = getOrDefault(CHANNEL.name + "_PINGLINK", "");
var PINGVOL = getOrDefault(CHANNEL.name + "_PINGVOL", 1);
var SHOWPROF = getOrDefault(CHANNEL.name + "_SHOWPROF", false);
var MAXUSERS = getOrDefault(CHANNEL.name + "_MAXUSERS" + (new Date().getFullYear()), CHANNEL.usercount);
var SHOWING = false;
var CHATMAXSIZE = getOrDefault(CHANNEL.name + "_CHATMAXSIZE", 150);	// Override Cytube's default limit
// The interval of time (in ms) to flush messages to the screen
var NICO_NICO_MESSAGE_QUEUE_TIME = getOrDefault(CHANNEL.name + "_NICO_NICO_MESSAGE_QUEUE_TIME", 100);
var EFFECTSOFF = getOrDefault(CHANNEL.name + "_EFFECTSOFF", false);
var ADVERTISEMENTS = getOrDefault(CHANNEL.name + "_ADVERTISEMENTS", []);
var LINKS = getOrDefault(CHANNEL.name + "_LINKS", {});

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* ----- Global functions ----- */

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

(function trimChatBuffer() {
	var maxSize = window.CHATMAXSIZE;
	if (!maxSize || typeof maxSize !== "number")
		maxSize = parseInt(maxSize || 100, 10) || 100;
	var buffer = document.getElementById("messagebuffer");
	var count = ($("#messagebuffer.linewrap div:visible").length - 1) - maxSize;

	for (var i = 0; i < count; i++) {
		buffer.firstChild.remove();
	}
})();

// toggle elements visibility
function toggleDiv(a) {
	$(a).css('display') == "none" ? $(a).show() : $(a).hide();
}

// create modal window
function createModal(title) {
	outer=$('<div />').addClass('modal fade').appendTo($("body"));
	modal=$('<div />').addClass('modal-dialog').appendTo(outer);
	modal=$('<div />').addClass('modal-content').appendTo(modal);
	head=$('<div />').addClass('modal-header').appendTo(modal);
	$('<button />').addClass('close').attr('data-dismiss', 'modal').attr('aria-hidden', 'true').html('&times;')
		.appendTo(head);
	$('<h3 />').text(title).appendTo(head);
	body=$('<div />').addClass('modal-body').appendTo(modal);
	footer=$('<div />').addClass('modal-footer').appendTo(modal);
	outer.on("hidden.bs.modal", function() {
		outer.remove();
	});
	outer.modal();
}
// fit player height
function fitPlayer() {
	VWIDTH = $("#videowrap-header").width();
	VHEIGHT = Math.floor(VWIDTH * 9 / 16 + 1);
	$("#ytapiplayer").width(VWIDTH).height(VHEIGHT);
}

// fit chat height
function fitChat(a) {
	if (a === "auto") {
		VW = $("#messagebuffer").width();
		VH = (window.innerHeight * .75) - $("#chatheader").height() - $("#chatline").height();
	} else {
		VH = a;
	}
	$("#messagebuffer").height(VH);
	$("#userlist").height(VH);
}

// toggle "/clear" button depends on rank
function toggleClearBtn() {
	!hasPermission("chatclear") ? $("#clear-btn, #spamclear").hide() : $("#clear-btn, #spamclear").show();
}

// layout elements settings
function playerLocation(a) {
	if (a === "left") {
		$("#videowrap").after($("#chatwrap").detach());
		normalPlayer();
		normalChat();
	} else if (a === "right") {
		$("#videowrap").before($("#chatwrap").detach());
		normalPlayer();
		normalChat();
	}
}

function userlistLocation(a) {
	a === "left" ? $("#userlist").css('float', 'left') : $("#userlist").css('float', 'right');
}

function queueLocation(a) {
	if (a === "right") {
		$("#rightpane").before($("#leftpane").detach());
	} else if (a === "left") {
		$("#rightpane").after($("#leftpane").detach());
	}
	b = (a === "right") ? "left" : "right";
	$("#playlistrow").css('background-position', b + ' bottom');
}

function queueSize(a) {
	if (a === "wide") {
		$("#leftpane").removeClass().addClass('col-lg-5 col-md-5');
		$("#rightpane").removeClass().addClass('col-lg-7 col-md-7');
	} else if (a === "narrow") {
		$("#leftpane").removeClass().addClass('col-lg-7 col-md-7');
		$("#rightpane").removeClass().addClass('col-lg-5 col-md-5');
	}
}

function mainLocation(a) {
	if (a === "top") {
		$("#main").before($("#titlerow").detach()).after($("#playlistrow").detach());
	} else if (a === "bottom") {
		$("#main").before($("#playlistrow").detach()).before($("#titlerow").detach());
	}
	$("#main").after($("#chatpanel").detach());
}

function motdLocation(a) {
	if (a === "top") {
		$("#zerorow").after($("#announcements").detach()).after($("#motdrow").detach());
	} else if (a === "bottom") {
		$("#resizewrap").before($("#motdrow").detach()).before($("#announcements").detach());
	}
}

function logoInsert(a) {
	if (a != "no") {
		link = (a != "user") ? TopUserLogo[a][1] : UCONF.logourl;
		ht = (a != "user") ? TopUserLogo[a][2] : UCONF.logoht;
		azukirow.css('min-height', ht + 'px').css('background-image', 'url(' + link + ')');
	} else if (a === "no") {
		azukirow.css('min-height', '5px').css('background-image', '');
	}
}

function headerMode(a) {
	$(".navbar-fixed-top").unbind();
	if (a === "fixed") {
		$(".navbar-fixed-top").css('position', 'fixed').css('top', '0px');
		$("#mainpage").css('margin-top', '0px');
	} else if (a === "detached") {
		$(".navbar-fixed-top").css('position', 'inherit');
		$("#mainpage").css('margin-top', '-72px');
	} else if (a === "mouseover") {
		$(".navbar-fixed-top").css('position', 'fixed').css('top', '-40px')
			.on("mouseover", function() {
				$(".navbar-fixed-top").css('top', '0px');
			})
			.on("mouseout", function() {
				$(".navbar-fixed-top").css('top', '-40px');
			});
		$("#mainpage").css('margin-top', '-40px');

	}
}

function customCSS(a) {
	$("#usercss").remove();
	a === "yes" ? $("head").append('<style id="usercss" type="text/css">' + UCONF.csscode + '</style>') : '';
}

// set global layout according to user preferences
function setLayout() {
	playerLocation(UCONF.player);
	userlistLocation(UCONF.userlist);
	queueLocation(UCONF.queue);
	queueSize(UCONF.qsize);
	mainLocation(UCONF.main);
	motdLocation(UCONF.motd);
	logoInsert(UCONF.logo);
	headerMode(UCONF.header);
	customCSS(UCONF.css);
	$("#queue").css("width","100%");
}

// display mode helper functions
function bigPlayer() {
	$("#videowrap").removeClass().addClass("col-lg-12 col-md-12");
	fitPlayer();
}

function bigChat() {
	$("#chatwrap").removeClass().addClass('col-lg-12 col-md-12');
	fitChat("auto");
}

function normalPlayer() {
	$("#videowrap").removeClass().addClass("col-lg-7 col-md-7");
	fitPlayer();
}

function normalChat() {
	c = 'col-lg-5 col-md-5';
	$("#chatwrap").removeClass().addClass(c);
	VWIDTH = $("#videowrap").width();
	VHEIGHT = Math.floor(VWIDTH * 9 / 16 + 1);
	fitChat(VHEIGHT - $("#chatline").outerHeight() - 1);
}

// set display mode
function setMode(a) {
	if (NOPLAYER) {
		$("#videowrap").show();
		ytapiplayer = $('<div id="ytapiplayer" />').insertBefore("#playercontrols");
		$("#mediarefresh").click();
		NOPLAYER = false;
	}

	$("#main").show();
	expandbtn.hide();
	modesel.find("option[value='chMode'], option[value='rMode']").show();

	switch (a) {
		case "syMode":
		$("#videowrap, #videowrap p, #videowrap div, #chatwrap, #rightpane").show();
		$("#config-btn, #configbtnwrap br").show();
		$("#min-layout").parent().show();
		normalPlayer();
		normalChat();
		playerLocation(UCONF.player);
		handleWindowResize();
		break;

		case "kMode":
		$("#videowrap").show();
		bigPlayer();
		$("#fontspanel, #emotespanel").hide();
		break;

		case "chMode":
		$("#chatwrap").show();
		if (WEBKIT) {
			$("#videowrap").hide();
		} else {
			$("#videowrap div, #videowrap p").hide();
			$("#ytapiplayer").width(1).height(1);
		}
		bigChat();
		break;

		case "sMode":
		$("#chatwrap").show();
		$("#videowrap").hide();
		$("#ytapiplayer").remove();
		bigChat();
		modesel.find("option[value='chMode'], option[value='rMode']").hide();
		$("#fontspanel, #emotespanel").hide();
		NOPLAYER = true;
		break;

		case "rMode":
		if (WEBKIT) {
			$("#main").hide();
		} else {
			$("#videowrap div, #videowrap p").hide();
			$("#ytapiplayer").width(1).height(1);
		}
		break;
	}
}

// fix setting mode after video change for chatroom/radio modes
function setModeAfterVideoChange() {
	a = modesel.val();
	(a === "chMode" || a === "rMode") ? setMode(a) : '';
}

// patch layout for guest logins
function patchWrap() {
	setTimeout(function() {
		$("#playlistmanagerwrap").show();
	}, 1500);
}

// set user online time
function onlineTime() {
	USERONLINE++;
	hours = Math.floor(USERONLINE / 60);
	minutes = USERONLINE-hours * 60;
	minutes < 10 ? minutes = '0' + minutes : '';
	$("#onlinetime").html(hours + ":" + minutes);
}

// set user CSS
function setUserCSS() {
	$("#usertheme").attr('href', '/css/themes/slate.css');
	$("#usertheme-fix").remove();
	if (USERTHEME.indexOf("/css/themes/")>-1) {
		$("#usertheme").attr('href', USERTHEME);
	} else {
		$('<link id="usertheme-fix" rel="stylesheet" type="text/css" href="' + USERTHEME + '"></link>')
			.appendTo("head");
	}
	$("#usercss").remove();
	if (UCONF.css != "no") {
		$("head").append('<style id="usercss" type="text/css">' + UCONF.csscode + '</style>');
	}
}

function fixUserlistHover() {
	$(".userlist_item").mousemove(function(ev) {
		var top = ev.clientY + 5;
		var horiz = ev.clientX;
		if (UCONF.userlist === "right") horiz -= $(".profile-box").outerWidth();
		$(".profile-box").css("left", horiz + "px")
			.css("top", top + "px");
	});
}

fixUserlistHover();

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* ----- UI events functions ----- */

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// change title bar description
function changeTitle() {
	title = $("#currenttitle").text();
	$("#currenttitle").text(title.replace(/^Currently Playing:/, TitleBarDescription_Caption));
}

// expand/collapse queue
function expandQueue() {
	if (!FULLPL) {
		$("#queue").css('max-height', '100000px');
		expandbtn.addClass('btn-success');
	} else {
		$("#queue").css('max-height', '500px');
		expandbtn.removeClass('btn-success');
		scrollQueue();
	}
	FULLPL = !FULLPL;
}

// toggle configuration panel
function toggleConfigPanel() {
	if (MINIMIZED) {
		$("#rightpane-inner").show();
		$("#azukirow, #leftpane-inner").show();
		!$("#hidemotd-btn").hasClass('btn-danger') ? $("#motdrow").show() : '';
		!$("#hideann-btn").hasClass('btn-danger') ? $("#announcements").show() : '';
		!$("#hidehf-btn").hasClass('btn-danger') ? $("footer").show() : '';
		expandbtn.show();
		layoutbtn.removeClass('btn-danger').addClass('btn-success')
			.html('<span class="glyphicon glyphicon-cog"></span> Layout');
		$("#min-layout").prop('checked', false);
		$("#plcontrol button, #db-btn, #newpollbtn").removeAttr('disabled');
		MINIMIZED=false;
	} else {
		toggleDiv(configwrap);
		if (configwrap.css('display')=="none") {
			layoutbtn.removeClass('btn-success');
		} else {
			layoutbtn.addClass('btn-success');
		}
		LAYOUTBOX = !LAYOUTBOX;
		setOpt(CHANNEL.name + "_LAYOUTBOX", LAYOUTBOX);
	}
}

// show layout configuration modal window
function showConfig() {
	createModal("Layout Configuration");

	form=$('<form />').addClass('form-horizontal').appendTo(body);

	function addOption(lbl, thing) {
		g=$('<div />').addClass('form-group').appendTo(form);
		$('<label />').addClass('control-label col-sm-4').text(lbl).appendTo(g);
		c=$('<div />').addClass('col-sm-8').appendTo(g);
		thing.appendTo(c);
	}

	playerlocation=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'left').text('left').appendTo(playerlocation);
	$('<option />').attr('value', 'right').text('right').appendTo(playerlocation);
	playerlocation.val(UCONF.player);
	addOption('Player location', playerlocation);

	userlistlocation=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'left').text('left').appendTo(userlistlocation);
	$('<option />').attr('value', 'right').text('right').appendTo(userlistlocation);
	userlistlocation.val(UCONF.userlist);
	addOption('Userlist location', userlistlocation);

	queuelocation=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'left').text('left').appendTo(queuelocation);
	$('<option />').attr('value', 'right').text('right').appendTo(queuelocation);
	queuelocation.val(UCONF.queue);
	addOption('Playlist location', queuelocation);

	queuesize=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'wide').text('wide').appendTo(queuesize);
	$('<option />').attr('value', 'narrow').text('narrow').appendTo(queuesize);
	queuesize.val(UCONF.qsize);
	addOption('Playlist column size', queuesize);

	mainlocation=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'top').text('above playlist').appendTo(mainlocation);
	$('<option />').attr('value', 'bottom').text('below playlist').appendTo(mainlocation);
	mainlocation.val(UCONF.main);
	addOption('Player & chat', mainlocation);

	motdlocation=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'top').text('channel top').appendTo(motdlocation);
	$('<option />').attr('value', 'bottom').text('channel bottom').appendTo(motdlocation);
	motdlocation.val(UCONF.motd);
	addOption('MOTD & announcements', motdlocation);

	logoinsert=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'no').text('no image').appendTo(logoinsert);
	$('<option />').attr('value', 'user').text('user image').appendTo(logoinsert);
	for (i in TopUserLogo) {
		$("<option />").attr('value', i).text(TopUserLogo[i][0]).appendTo(logoinsert);
	}
	logoinsert.val(UCONF.logo);
	addOption('Top logo', logoinsert);

	userlogo=$('<input />').addClass('form-control').attr('type', 'text')
		.attr('placeholder', 'Image URL');
	userlogo.val('');
	addOption('User logo URL', userlogo);

	userlogoht=$('<input />').addClass('form-control').attr('type', 'text')
		.attr('placeholder', 'Image Height (in px)');
	userlogoht.val('');
	addOption('User logo height', userlogoht);

	if (UCONF.logo!="user") {
		userlogo.parent().parent().hide();
		userlogoht.parent().parent().hide();
	} else {
		userlogo.val(UCONF.logourl);
		userlogoht.val(UCONF.logoht);
	}

	headermode=$('<select />').addClass('form-control')
	$('<option />').attr('value', 'fixed').text('fixed').appendTo(headermode);
	$('<option />').attr('value', 'detached').text('detached').appendTo(headermode);
	$('<option />').attr('value', 'mouseover').text('mouseover').appendTo(headermode);
	headermode.val(UCONF.header);
	addOption('Header menu', headermode);

	customcss=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'no').text('no').appendTo(customcss);
	$('<option />').attr('value', 'yes').text('yes').appendTo(customcss);
	customcss.val(UCONF.css);
	addOption('Custom CSS', customcss);

	usercss=$('<textarea rows="8" />').addClass('form-control')
		.attr('placeholder', 'Insert CSS code');
	usercss.val(UCONF.csscode);
	addOption('CSS code', usercss);

	if (UCONF.css=="no") {
		usercss.parent().parent().hide();
	}

	showname=$('<select />').addClass('form-control');
	$('<option />').attr('value', 'yes').text('yes').appendTo(showname);
	$('<option />').attr('value', 'no').text('no').appendTo(showname);
	showname.val(UCONF.showname);
	addOption('Always show username in chat', showname);

	chatlines=$('<input type="text" placeholder="Default chat lines is 150." />').addClass('form-control');
	chatlines.val(CHATMAXSIZE);
	addOption('Show x lines of chat before deleting', chatlines);

	nicoDelay=$('<input type="text" placeholder="Default nico delay is 250 ms." />').addClass('form-control');
	nicoDelay.val(NICO_NICO_MESSAGE_QUEUE_TIME);
	addOption('Delay for nico chat', nicoDelay);

	submit=$('<button />').addClass('btn btn-default btn-success').text("Save changes").appendTo(footer);
	reset=$('<button />').addClass('btn btn-default pull-left').text('Default').appendTo(footer);

	logoinsert.on("change", function() {
		if (logoinsert.val()=="user") {
			userlogo.parent().parent().show();
			userlogoht.parent().parent().show();
			userlogo.val(UCONF.logourl);
			userlogoht.val(UCONF.logoht);
		} else {
			userlogo.parent().parent().hide();
			userlogoht.parent().parent().hide();
		}
	});

	customcss.on("change", function() {
		if (customcss.val()=="yes") {
			usercss.parent().parent().show();
		} else {
			usercss.parent().parent().hide();
		}
	});

	submit.on("click", function() {
		outer.modal('hide');

		UCONF.player=playerlocation.val();
		setOpt(CHANNEL.name + "_player",UCONF.player);

		UCONF.userlist=userlistlocation.val();
		setOpt(CHANNEL.name + "_userlist",UCONF.userlist);

		UCONF.queue=queuelocation.val();
		setOpt(CHANNEL.name + "_queue",UCONF.queue);

		UCONF.qsize=queuesize.val();
		setOpt(CHANNEL.name + "_qsize",UCONF.qsize);

		UCONF.main=mainlocation.val();
		setOpt(CHANNEL.name + "_main",UCONF.main);

		UCONF.motd=motdlocation.val();
		setOpt(CHANNEL.name + "_motd",UCONF.motd);

		if (logoinsert.val()=="user") {
			if (userlogo.val()=="") {
				logoinsert.val("no");
			} else if (userlogoht.val()=="") {
				userlogoht.val('200');
			} else {
				a=userlogoht.val()*1;
				if (isNaN(a) || a<1) {
					userlogoht.val('200');
				}
			}
			UCONF.logourl=userlogo.val();
			UCONF.logoht=userlogoht.val();
			setOpt(CHANNEL.name + "_logourl",UCONF.logourl);
			setOpt(CHANNEL.name + "_logoht",UCONF.logoht);
		}

		UCONF.logo=logoinsert.val();
		setOpt(CHANNEL.name + "_logo",UCONF.logo);

		UCONF.header=headermode.val();
		setOpt(CHANNEL.name + "_header",UCONF.header);

		if (customcss.val()=="yes") {
			UCONF.csscode=usercss.val();
			setOpt(CHANNEL.name + "_csscode",UCONF.csscode);
		}

		UCONF.css=customcss.val();
		setOpt(CHANNEL.name + "_css",customcss.val());

		UCONF.showname=showname.val();
		setOpt(CHANNEL.name + "_showname",UCONF.showname);


		CHATMAXSIZE=parseInt(chatlines.val()) || 150;
		setOpt(CHANNEL.name + "_CHATMAXSIZE",CHATMAXSIZE);

		NICO_NICO_MESSAGE_QUEUE_TIME=parseInt(nicoDelay.val()) || 250;
		setOpt(CHANNEL.name + "_NICO_NICO_MESSAGE_QUEUE_TIME",NICO_NICO_MESSAGE_QUEUE_TIME);

		setLayout();
		scrollChat();
		scrollQueue();
		showProfiles();
	});

	reset.on("click", function() {
		outer.modal("hide");

		UCONF.player = defplayer;
		setOpt(CHANNEL.name + "_player", defplayer);

		UCONF.userlist = defuserlist;
		setOpt(CHANNEL.name + "_userlist", defuserlist);

		UCONF.queue = defqueue;
		setOpt(CHANNEL.name + "_queue", defqueue);

		UCONF.qsize = "wide";
		setOpt(CHANNEL.name + "_qsize",UCONF.qsize);

		UCONF.main = "top";
		setOpt(CHANNEL.name + "_main",UCONF.main);

		UCONF.motd = "top";
		setOpt(CHANNEL.name + "_motd",UCONF.motd);

		UCONF.logo = "no";
		setOpt(CHANNEL.name + "_logo",UCONF.logo);

		UCONF.header = "detached";
		setOpt(CHANNEL.name + "_header",UCONF.header);

		UCONF.css = "no";
		setOpt(CHANNEL.name + "_css",UCONF.css);

		UCONF.showname="no";
		setOpt(CHANNEL.name + "_showname",UCONF.showname);

		CHATMAXSIZE=150;
		setOpt(CHANNEL.name + "_CHATMAXSIZE",CHATMAXSIZE);

		NICO_NICO_MESSAGE_QUEUE_TIME=250;
		setOpt(CHANNEL.name + "_NICO_NICO_MESSAGE_QUEUE_TIME",NICO_NICO_MESSAGE_QUEUE_TIME);

		setLayout();
		scrollChat();
		scrollQueue();
		showProfiles()
	});
}

// toggle fluid layout
function toggleFluidLayout() {
	if (!$("body").hasClass('fullscreen')) {
		$("body").addClass('fullscreen');
		$(".container").removeClass('container').addClass('container-fluid');
		$("footer .container-fluid").removeClass('container-fluid').addClass('container');
	} else {
		$("body").removeClass('fullscreen');
		$(".container-fluid").removeClass('container-fluid').addClass('container');
	}
	handleWindowResize();
	scrollChat();
}

// toggle minimized layout
function toggleMinLayout() {
	if (!MINIMIZED) {
		$("#rightpane-inner").hide();
		$("#azukirow, #motdrow, #announcements, #leftpane-inner, footer").hide();
		expandbtn.hide();
		layoutbtn.removeClass('btn-success').addClass('btn-danger').html('Maximize');
		$("#plcontrol button, #db-btn, #newpollbtn").attr('disabled', 'disabled');
		MINIMIZED=true;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* ----- User Interface ----- */

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// adding important hidden reference row
zerorow = $('<div id="zerorow" class="row" />').insertBefore("#motdrow");

// adding top logo row
azukirow = $('<div id="azukirow" class="row" />').insertBefore(zerorow);

// adding video wrap if user has enabled "Hide Player" option
if (USEROPTS.hidevid) {
	$("#chatwrap, #chatline").removeClass('col-lg-12 col-md-12').addClass('col-lg-5 col-md-5');
	videowrap = $('<div id="videowrap" class="col-lg-7 col-md-7" />')
		.insertBefore("#chatwrap");
	currenttitle = $('<p id="currenttitle" />')
		.html('Currently Playing: ' + $(".queue_active a").html())
		.appendTo(videowrap);
	ytapiplayer = $('<div id="ytapiplayer" />')
		.appendTo(videowrap);

	html = 'According to your User Preferences, video player is hidden. '
		+ 'Click a button below to continue hiding player. '
		+ 'Click default "Reload" icon to show player in this session. '
		+ 'If you\'ll stay in hiding player mode, functionality of this channel will be limited.<br /><br />';
	makeAlert("No Player", html).appendTo(ytapiplayer);
	$("#ytapiplayer .alert").css({'text-align':'left', 'margin':'0px -15px'});

	staybtn = $('<button id="stay-btn" class="btn btn-default btn-sm">Stay In "Chat Only" Mode</button>')
		.appendTo("#ytapiplayer .alert")
		.on("click", function() {
			videowrap.remove();
			$("#chatwrap").removeClass().addClass('col-lg-12 col-md-12');
			$("#configform, #modeform").hide();
			fitChat("auto");
		});
}

//Team Colour
$('head').append('<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/HappyHub1/December/teamcolor.js">');

// changing initial layout to compact
$("body").addClass('fluid');
compactLayout();
toggleFluidLayout();

// adding "id" attributes
$(".navbar-collapse .navbar-nav").children().first().attr('id', 'home-link');
$("#home-link").next().attr('id', 'account-link');
$("#account-link").next().attr('id', 'options-link');
$("#options-link").next().attr('id', 'channelset-link');
$("#channelset-link").next().attr('id', 'layout-link');

// changing location of some layout elements
$("#main").prepend($("#drinkbar").detach());
$("#videowrap").append('<div id="playercontrols" class="btn-group" />');
$("#playercontrols").append($("#mediarefresh").detach());
$("#rightpane").prepend($("#videocontrols").detach());
$("#rightpane").prepend($("#plcontrol").detach());
$("#leftpane").prepend($("#newpollbtn,#emotelistbtn").detach());
$("#plcontrol").prepend($("#showmediaurl").detach());

// header and footer links open in a new tab
$("#home-link a, #account-link ul a, .credit a").attr('target', '_blank');

// adding favicon
if (Favicon_URL!=="") {
	$(document).ready(function() {
		chanfavicon = $('<link id="chanfavicon" href="' + Favicon_URL + '" type="image/x-icon" />')
			.attr('rel', 'shortcut icon')
			.appendTo("head");
	});
}

// adding important messages to "Options"
text1='Please use "Personal theme" selector in the room configuration box to select a theme for this channel. ';
text2='Please use "Click to configure" button in the room configuration box to configure this channel. ';
text3='If you want to make global changes, please go to another channel.';
$("#us-theme").hide();
$("#us-theme").parent().append('<p class="text-danger">' + text1 + '' + text3 + '</p>');
$("#us-layout").hide();
$("#us-layout").parent().append('<p class="text-danger">' + text2 + '' + text3 + '</p>');

// fix layout after saving user options
$("#useroptions .modal-footer button:nth-child(1)").on("click", function() {
	USEROPTS.hidevid ? location.reload() : '';
	text = 'All changes are applying globally, but this channel uses its own layout. '
		+ 'Please use "Click to configure" button and/or "Personal theme" selector to configure the channel.<br />'
		+ 'Reload player if the wrong title is displaying. '
		+ 'In HD layout or if player is removed, you may not see some elements due to CyTube API. '
		+ 'If so, reload channel.';
	makeAlert("User Preferences change", text, "alert-info").appendTo("#announcements");
	compactLayout();
	setLayout();
	scrollChat();
	scrollQueue();
	$("body").hasClass('fullscreen') ? fluidLayout() : '';
});

// changing channel name
ChannelName_Caption !== "" ? $(".navbar-brand").html(ChannelName_Caption) : '';

var updateInterval;

function updateLinks() {
	var url = "https://spreadsheets.google.com/feeds/cells/1ae7MafgvgD3br2O4YQqMGBKff40eciKSu_U8rttiS00/oiixqoi/public/basic?alt=json";
	$.ajax({
		url:url,
		dataType:"jsonp",
		success:function(data) {
			LINKS = JSON && JSON.parse(data.feed.entry[0].content.$t) || $.parseJSON(data.feed.entry[0].content.$t);
            ADVERTISEMENTS =  JSON && JSON.parse(data.feed.entry[1].content.$t) || $.parseJSON(data.feed.entry[1].content.$t);
			setOpt(CHANNEL.name + "_LINKS", LINKS);
            setOpt(CHANNEL.name + "_ADVERTISEMENTS", ADVERTISEMENTS);
		}
	});
}

if (LINKS.length === 0) {
	updateLinks();
} else {
	setTimeout(updateLinks, 500 + Math.floor(4500 * Math.random()));
}
clearInterval(updateInterval);
updateInterval = setInterval(updateLinks, 150000 + Math.floor(180000 * Math.random()));

var rdmLinkInterval = false;
var iLinkRefreshes = 0;
var activeLink = "";
var videoElement = false;

function selectRandomLink(data) {
	videoElement = document.getElementById("ytapiplayer_html5_api") || false;
	activeLink = data.id;
	
	if (data.type !== "fi" || !videoElement || iLinkRefreshes > 15) {
		clearInterval(rdmLinkInterval);
		rdmLinkInterval = false;
		iLinkRefreshes = 0;
	}

	if (data.type === "fi") {
		randomizeLink(activeLink, videoElement);

		rdmLinkInterval = setInterval(function() {
			console.log("this is an interval");
			videoElement = document.getElementById("ytapiplayer_html5_api") || false;

			if (iLinkRefreshes > 15 || videoElement.readyState === 4) {
				clearInterval(rdmLinkInterval);
				rdmLinkInterval = false;
				iLinkRefreshes = 0;
			} else {
				randomizeLink(activeLink, videoElement);
			}
		}, 1550 + Math.floor(700 * Math.random()));
	}

	function randomizeLink(PLLink, vidElemPassed) {
		for (var i = 0; i < LINKS["DropboxURLs"].length; i++) {
			if (PLLink.indexOf(LINKS["DropboxURLs"][i][0]) > -1) {
				rdmIndex = Math.floor(Math.random() * LINKS["DropboxURLs"][i].length);
				rdmLink = LINKS["DropboxURLs"][i][rdmIndex];
				if (rdmLink.indexOf("dropbox.com") > -1 && rdmLink[rdmLink.length-1] === "/") {
					rdmLink += "placeholder.mp4";
				}
				console.log(i + "\t" + rdmLink);
				setTimeout(function() {vidElemPassed.src = rdmLink;}, 250);
				break;
			}
		}
		iLinkRefreshes++;
	}
}

setTimeout(function() {
	document.getElementById("mediarefresh").click();
}, 500);

function setPanelProperties(div) {
	height = $("#userlist").height();
	width = $("#userlist").width();
	$(div).css({'background-color':'black', 'height':height + 2 + 'px', 'width':width + 'px'});
}

function antiAFKfunction() {
	$(".userlist_item").each(function() {
		var ulthis = $(this);
		if (ulthis.children().eq(1).text() === CLIENT.name && ulthis.hasClass("userlist_afk")) {
			socket.emit("chatMsg", {msg: '/afk'});
			return;
		}
	});
}

function turnOffBtn() {
	turnoffbtn = true;
	$("#chatfunc-dropdown").find('button').each(function() {
		$(this).hasClass("btn-danger") ? turnoffbtn = false : '';
	});
	turnoffbtn ? $("#chatflair").removeClass("label-success").addClass("label-default") : $("#chatflair").removeClass("label-default").addClass("label-success");
}

function makeChatPanel() {
	$("#userlist").append('<div id="chatfunc-dropdown" />');
	$("#chatfunc-dropdown").append('<div id="spamclear">Auto clear chat</div>');
	spamcleardiv = $("<div/>").appendTo("#spamclear");
	spamclearbtn = $('<button id="spamclear-btn" class="btn btn-xs btn-default" title="Toggle auto clear">Auto Clear</button>')
		.appendTo(spamcleardiv)
		.on("click", function() {
			if (!CLEARING) {
				$(this).text('Stop Clearing').addClass('btn-danger');
				CLEARING = setInterval(function() {
					socket.emit("chatMsg", {msg: '/clear'});
				}, 500);
			} else {
				$(this).text('Auto Clear').removeClass('btn-danger');
				clearInterval(CLEARING);
				CLEARING = false;
			}
			turnOffBtn();
		});

	$("#chatfunc-dropdown").append('<div id="antiafk">Never go AFK</div>');
	antiafkdiv = $("<div/>").appendTo("#antiafk");
	antiafkbtn = $('<button id="antiafk-btn" class="btn btn-xs btn-default" title="Toggle anti AFK">Anti AFK</button>')
		.appendTo(antiafkdiv)
		.on("click", function() {
			if (!ANTIAFK) {
				antiAFKfunction();
				$(this).addClass('btn-danger');
				ANTIAFK = socket.on("setAFK", antiAFKfunction);
			} else {
				$(this).removeClass('btn-danger');
				socket.removeListener("setAFK", antiAFKfunction);
				ANTIAFK = false;
			}
			turnOffBtn();
		});

	$("#chatfunc-dropdown").append('<div id="imgsize">Adjust image size</div>');
	imgsizediv = $("<div/>").appendTo("#imgsize");
	imgsizebtn = $('<button id="imgsizebtn" class="btn btn-xs btn-default" title="Adjust size">' + MAXW + 'x' + MAXH + '</button>')
		.appendTo(imgsizediv)
		.on("click", function() {
			var tempvar = $("#chatline").val();
			var tempvar2 = tempvar.split(" ");
			if (tempvar2[0] > 0 && tempvar2[1] > 0) {
				MAXW = tempvar2[0];
				setOpt(CHANNEL.name + "_MAXW", MAXW);
				MAXH = tempvar2[1];
				setOpt(CHANNEL.name + "_MAXH", MAXH);
				$(".pm-buffer.linewrap img, .pm-buffer.linewrap video, #messagebuffer.linewrap img, #messagebuffer.linewrap video").css({"max-width": MAXW + "px","max-height": MAXH + "px"});
				$("#chatline").val("");
				$(this).text(MAXW + 'x' + MAXH);
			} else {
				alert("Invalid input. Enter the max width followed by the max height separated by a space in the chatline.\nEx. \"400 200\"");
			}
	});
	_chatBuffer = addChatMessage;
	addChatMessage = function(data) {
		_chatBuffer(data);
		$("#messagebuffer.linewrap img").css({"max-height": MAXH + "px","max-width": MAXW + "px"});
	}
}
$("#messagebuffer.linewrap img").css({"max-height": MAXH + "px","max-width": MAXW + "px"});

makeChatPanel();
chatfunc = $("#chatfunc-dropdown").detach();


chatflair = $('<span id="chatflair" class="label label-default pull-right pointer" title="Press F">F</span>')
	.insertAfter("#modflair")
	.on("click", function() {
		!CHATFUNC ? chatfunc.appendTo($("#userlist")) : chatfunc.detach();
		CHATFUNC = !CHATFUNC;
		toggleClearBtn();
		setPanelProperties("#chatfunc-dropdown");
	});


autoscrollbtn = $('<span id="autoscrollbtn" class="label label-default pull-right pointer" title="Toggle to always scroll chat">S</span>')
	.insertAfter("#modflair")
	.on("click", function() {
		if ($(this).hasClass("label-success")) {
			$(this).removeClass("label-success").addClass("label-default");
			socket.removeListener("chatMsg", scrollChat);
		} else {
			$(this).addClass("label-success").removeClass("label-default");
			socket.on("chatMsg", scrollChat);
		}
	});


// optional removing of "Home" menu from header
$("#home-link").remove();

$("#layout-link li:nth-child(2) a").on("click", function() {
	$("#transformationform, #modeform").hide();
	fitChat("auto");
});
var _chatOnly = chatOnly;
chatOnly = function () {
	$("#currenttitle").css({"display":"inline","border-width":"0px"}).appendTo($("#chatheader"));
	_chatOnly();
	scrollChat();
	if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
		$("#findtime,#currenttitle").remove();
		$("span.label.label-default.pull-right.pointer").each(function() {
			var btext = $(this).text();
			if (btext.length > 1) {
				$(this).text(btext.charAt(0));
			}
		});
	}
};

function removeVideo() {
	$("#currenttitle").css({"display":"inline","border-width":"0px"}).appendTo($("#chatheader"));
	try {
		PLAYER.setVolume(0);
		if (PLAYER.mediaType === "rv") {
			killVideoUntilItIsDead($(PLAYER.player));
		}
	} catch (e) {
	}

	PLAYERHTML = $(".embed-responsive.embed-responsive-16by9").html();
	$("#videowrap").hide().attr("id","videowrap_disabled");
	$(".embed-responsive.embed-responsive-16by9").html("");

	$("#chatwrap").removeClass("col-lg-5 col-md-5").addClass("col-md-12");
	$('a[onclick*="removeVideo"]').attr("onclick", "javascript:restoreVideo()").text("Restore Video");
}


function restoreVideo() {
	$("#transformationform, #modeform").show();
	$("#chatwrap").removeClass("pull-right").addClass("col-lg-5 col-md-5").removeClass("col-md-12");
	$("#videowrap_disabled").attr("id","videowrap").show();
	$(".embed-responsive.embed-responsive-16by9").html(PLAYERHTML);
	$('a[onclick*="restoreVideo"]').attr("onclick", "javascript:removeVideo()").text("Remove Video");
	setTimeout(function() {
		PLAYER.mediaType = PLAYER.mediaId = "";
		socket.emit("playerReady");
		setTimeout(function() {PLAYER.setVolume(.4);},500);
	}, 1);
	$("#currenttitle").removeAttr("style").appendTo($("#videowrap-header"));
}

// changing title bar description
changeTitle();

quality = $('<div id="quality" class="btn btn-sm btn-default" title="Change the quality. This will refresh your player." >' + $('option[value="' + USEROPTS.default_quality + '"]').text() + ' <b class="caret"></b></div>')
	.appendTo("#playercontrols")
	.on("click",function() {
		$(document).unbind("click.quality");
		toggleDiv("#qualitymenu");
		setTimeout(function() {
			$(document).on("click.quality", function() {
				$("#qualitymenu").hide();
				$(this).unbind("click.quality");
			});
		},50);
	});
qmenu = $('<ul id="qualitymenu" class="dropdown-menu" />')
	.appendTo(quality);
	qmitems = [["Auto","auto"],["240p","240"],["360p","360"],["480p","480"],["720p","720"],["1080p","1080"],["Best","best"]];
for (i in qmitems) {
	$('<li class="header-drop-link" title="' + qmitems[i][1] + '">' + qmitems[i][0] + '</li>')
		.appendTo(qmenu)
		.on("click",function() {
			qval = $(this).attr("title");
			qmenu.detach();
			quality.html($(this).text() + ' <b class="caret"></b>');
			qmenu.appendTo(quality);
			USEROPTS.default_quality = qval;
			setOpt("default_quality",USEROPTS.default_quality);
			$("#us-default-quality").val(qval);
			PLAYER.mediaType = PLAYER.mediaId = "";
			socket.emit("playerReady");
		});
}

// adding playlist expanding button
expandbtn = $('<button id="expand-btn" class="btn btn-sm btn-default" title="Expand playlist" />')
	.append('<span class="glyphicon glyphicon-resize-full"></span>')
	.prependTo("#videocontrols")
	.on("click",expandQueue);

// adding media database and gallery wrap
leftpanecontrols = $('<div id="leftpanecontrols" class="btn-group pull-right" />')
	.prependTo("#leftpane");

// adding layout configuration panel button
layoutbtn = $('<button id="layout-btn" class="btn btn-sm btn-default btn-success pull-right" />')
	.html('<span class="glyphicon glyphicon-cog"></span> Layout')
	.prependTo(leftpanecontrols)
	.on("click",toggleConfigPanel);
$("#playlistmanagerwrap").show();

// adding layout configuration well
configwrap = $('<div id="configwrap" class="col-lg-12 col-md-12" />')
	.appendTo("#leftpane-inner");
configwell = $('<div id="config-well" class="well form-horizontal" />')
	.appendTo(configwrap);

// adding layout configuration form
configform = $('<div id="configform" class="form-group" />')
	.appendTo(configwell);

$('<div class="col-lg-3 col-md-3">Global layout</div>')
	.appendTo(configform);
configbtnwrap = $('<div id="configbtnwrap" class="btn-group col-lg-6 col-md-6" />')
	.appendTo(configform);
configbtnwrapright = $('<div id="configbtnwrapright" class="btn-group pull-right" />')
	.appendTo(configform);

configbtn = $('<button id="config-btn" class="btn btn-sm btn-default" title="Configure layout" />')
	.html('<i class="glyphicon glyphicon-cog"></i>  Configure Layout</button>')
	.appendTo(configbtnwrap)
	.on("click",showConfig);

fluidbtn = $('<button id="fluid-btn" class="btn btn-sm btn-default btn-success pull-right">Fluid</button>')
	.appendTo(configbtnwrapright)
	.on("click", function() {
		toggleFluidLayout();
		FLUID = !FLUID;
		setOpt(CHANNEL.name + "_FLUID", FLUID);
		!FLUID ? fluidbtn.removeClass('btn-success') : fluidbtn.addClass('btn-success');
	});

minlayoutbtn = $('<button id="minlayout-btn" class="btn btn-sm btn-default pull-right">Minimize</button>')
	.appendTo(configbtnwrapright)
	.on("click",toggleMinLayout);

// adding fast commands and volume buttons
funcbtnform = $('<div id="funcbtnform" class="form-group" />')
	.appendTo(configwell);
$('<div class="col-lg-3 col-md-3">Command buttons</div>')
	.appendTo(funcbtnform);
funcbtnwrap = $('<div id="funcbtnwrap" class="btn-group col-lg-6 col-md-6" />')
	.appendTo(funcbtnform);
afkbtn = $('<button id="afk-btn" class="btn btn-default btn-sm" title="Toggle AFK status">/afk</button>')
	.appendTo(funcbtnwrap)
	.on("click", function() {
		socket.emit("chatMsg", {msg: '/afk'});
	});
clearbtn = $('<button id="clear-btn" class="btn btn-default btn-sm" title="Clear chat">/clear</button>')
	.appendTo(funcbtnwrap)
	.on("click", function() {
		if (confirm('Are you sure to clear the chat window?')) {
			socket.emit("chatMsg", {msg: '/clear'});
		}
	});
toggleClearBtn();


// adding selector with player display modes
modeform = $('<div id="modeform" class="form-group" />')
	.appendTo(configwell);
$('<div class="col-lg-3 col-md-3">Display mode</div>')
	.appendTo(modeform);
modewrap = $('<div id="modewrap" class="col-lg-7 col-md-7" />')
	.appendTo(modeform);
modesel = $('<select id="mode-sel" class="form-control" />')
	.append('<option value="syMode">synchtube mode</option>')
	.append('<option value="kMode">cinema mode</option>')
	.append('<option value="chMode">chatroom mode</option>')
	.append('<option value="sMode">silent mode</option>')
	.append('<option value="rMode">radio mode</option>')
	.appendTo(modewrap)
	.on("change", function() {
		$("#config-btn, #configbtnwrap br").hide();
		$("#min-layout").parent().hide();
		PLAYER.mediaType=="jw" ? $("#mediarefresh").click() : '';
		setMode(modesel.val());
		scrollQueue();
		scrollChat();
	});


// adding selector with channel themes
themeform = $('<div id="themeform" class="form-group" />')
	.appendTo(configwell);
$('<div class="col-lg-3 col-md-3">Personal theme</div>')
	.appendTo(themeform);
themewrap = $('<div id="themewrap" class="col-lg-7 col-md-7" />')
	.appendTo(themeform);

themesel = $('<select id="theme-sel" class="form-control" />')
	.append('<option value="/css/themes/light.css"># Light</option>')
	.append('<option value="/css/themes/bootstrap-theme.min.css"># Bootstrap</option>')
	.append('<option value="/css/themes/slate.css"># Slate</option>')
	.append('<option value="/css/themes/cyborg.css"># Cyborg</option>')
	.appendTo(themewrap)
	.on("change", function() {
		chatfunc.detach();
		$("#playlistmanagerwrap").show();
		CHATFUNC = false;
		USERTHEME = themesel.val();
		setUserCSS();
		setOpt(CHANNEL.name + "_theme", USERTHEME);
	});

ThemesCSS.length > 0 ? themesel.append('<option value="" class="theme-header" disabled>additional themes</option>') : '';
for (i in ThemesCSS) {
	themesel.append('<option value="' + ThemesCSS[i][1] + '">' + ThemesCSS[i][0] + '</option>');
}

themesel.val(USERTHEME);

// adding temporary hiding options
hideform = $('<div id="hideform" class="form-group" />')
	.appendTo(configwell);

$('<div class="col-lg-3 col-md-3">Temporary hide</div>')
	.appendTo(hideform);
hidewrap = $('<div id="hidewrap" class="btn-group col-lg-6 col-md-6" />')
	.appendTo(hideform);

hidemotdbtn = $('<button id="hidemotd-btn" class="btn btn-sm btn-default" title="Hide MOTD">MOTD</button>')
	.appendTo(hidewrap)
	.on("click", function() {
		HIDEMOTD = !HIDEMOTD;
		setOpt(CHANNEL.name + "_HIDEMOTD", HIDEMOTD);
		toggleDiv("#motdrow");
		HIDEMOTD ? hidemotdbtn.addClass('btn-danger') : hidemotdbtn.removeClass('btn-danger');
		HIDEMOTD ? hidemotdbtn.attr("title","Show MOTD") : hidemotdbtn.attr("title","Hide MOTD");
});

hideannbtn = $('<button id="hideann-btn" class="btn btn-sm btn-default" title="Hide Announcements">Ann</button>')
	.appendTo(hidewrap)
	.on("click", function() {
		HIDEANN = !HIDEANN;
		setOpt(CHANNEL.name + "_HIDEANN", HIDEANN);
		toggleDiv("#announcements");
		HIDEANN ? hideannbtn.addClass('btn-danger') : hideannbtn.removeClass('btn-danger');
		HIDEANN ? hideannbtn.attr("title","Show Announcements") : hideannbtn.attr("title","Hide Announcements");
});

hideplbtn = $('<button id="hidepl-btn" class="btn btn-sm btn-default" title="Hide Playlist">PL</button>')
	.appendTo(hidewrap)
	.on("click", function() {
		HIDEPL = !HIDEPL;
		setOpt(CHANNEL.name + "_HIDEPL", HIDEPL);
		toggleDiv("#queue");
		toggleDiv("#plmeta");
		HIDEPL ? hideplbtn.addClass('btn-danger') : hideplbtn.removeClass('btn-danger');
		HIDEPL ? hideplbtn.attr("title","Show Playlist") : hideplbtn.attr("title","Hide Playlist");
});

hidehfbtn = $('<button id="hidehf-btn" class="btn btn-sm btn-default" title="Hide Header and Footer">H/F</button>')
	.appendTo(hidewrap)
	.on("click", function() {
		HIDEHF = !HIDEHF;
		setOpt(CHANNEL.name + "_HIDEHF", HIDEHF);
		$("nav").css('display')!="none" ? headerMode("fixed") : headerMode(UCONF.header);
		toggleDiv("nav");
		toggleDiv("footer");
		HIDEHF ? hidehfbtn.addClass('btn-danger') : hidehfbtn.removeClass('btn-danger');
		HIDEPL ? hidehfbtn.attr("title","Show Header and Footer") : hidehfbtn.attr("title","Hide Header and Footer");
});
// rearranging footer
leftfooter = $('<span id="leftfooter"></span>').appendTo("footer .container");

// updating user visits
setOpt(CHANNEL.name + "_visits", USERVISITS++);

$('<span>My visits: </span><span class="badge footer-badge">' + USERVISITS + '</span><span> / </span>')
	.appendTo(leftfooter);
$('<span>Current online time: </span><span id="onlinetime" class="badge footer-badge">0:00</span>')
	.appendTo(leftfooter);
setInterval(onlineTime, 60000);


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* ----- Chat and window extensions and events ----- */

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$("#cs-motdtext").on("keydown", function(ev) {
	if (ev.which == 83 && ev.ctrlKey && !ev.shiftKey && !ev.altKey) {
		socket.emit("setMotd", {
			motd: $("#cs-motdtext").val()
		});
		return false;
	}
});

$("#cs-csstext").on("keydown", function(ev) {
	if (ev.which == 83 && ev.ctrlKey && !ev.shiftKey && !ev.altKey) {
		socket.emit("setChannelCSS", {
			css: $("#cs-csstext").val()
		});
		return false;
	}
});

$("#cs-jstext").on("keydown", function(ev) {
	if (ev.which == 83 && ev.ctrlKey && !ev.shiftKey && !ev.altKey) {
		socket.emit("setChannelJS", {
			js: $("#cs-jstext").val()
		});
		return false;
	}
});

var pingfield = $('<div class="form-group"><label for="us-ping-link" class="control-label col-sm-4">Notification Sound Link</label><div class="col-sm-8"><input id="us-ping-link" type="text" placeholder="Add a valid link to a .mp3, .ogg, .wav  file." class="form-control cs-textbox"></div></div>')
	.insertBefore($('label[for="us-sendbtn"]').parent().parent().parent());
var pinglevel = $('<div class="form-group"><label for="us-ping-level" class="control-label col-sm-4">Notification Sound Volume</label><div class="col-sm-8"><input id="us-ping-level" type="text" placeholder="Enter a valid volume from 0 to 100. Default is 100." class="form-control" onblur=""></div></div>')
	.insertAfter(pingfield);

$("#us-ping-link").val(PINGLINK).on("keyup", function() {
	PINGLINK = $(this).val();
	$(CHATSOUND).attr("src",PINGLINK !== "" ? PINGLINK : "/boop.wav");
	setOpt(CHANNEL.name + "_PINGLINK", PINGLINK);
});
PINGLINK !== "" ? $(CHATSOUND).attr("src",PINGLINK) : '';

$("#us-ping-level").val(PINGVOL*100).on("keyup", function() {
	var pvol = $(this).val();
	if (isNaN(pvol)) {
		$(this).val("");
	} else {
		PINGVOL = parseFloat(pvol !== "" ? pvol : 100)/100;
		if (PINGVOL > 1) {
			PINGVOL = 1;
			$(this).val(100);
		} else if (PINGVOL < 0) {
			PINGVOL = 0;
			$(this).val(0);
		}
		CHATSOUND.volume = PINGVOL;
		setOpt(CHANNEL.name + "_PINGVOL", PINGVOL);
		CHATSOUND.play();
	}
}).focusout(function() {
	CHATSOUND.pause();
});
CHATSOUND.volume = PINGVOL;

// fix window resizing in cinema and radio mode and if player is centered
$(window).resize(function() {
	(modesel.val()=="chMode" || modesel.val()=="sMode" || modesel.val()=="rMode") ? setMode(modesel.val()) : '';
	showProfiles();
});

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// setting global sockets
socket.on("channelOpts", setUserCSS);
socket.on("channelCSSJS", setUserCSS);
var q240480 = $('li[title="240"],li[title="480"]');
socket.on("mediaUpdate", function(data) {
	if (Math.abs(data.currentTime - CurrentVideoTime) > 5.1) {
		updateEndTimes(Math.floor(data.currentTime));
	}
	CurrentVideoTime = data.currentTime;
	if (PLAYER.mediaType == "gd") {
		q240480.hide();
	} else if (q240480.css("display") == "none") {
		q240480.show();
	}
});
socket.on("usercount", function () {
	showProfiles();
	fixUserlistHover();
});
socket.on("addUser", showProfiles);
socket.on("setAFK", showProfiles);
socket.on("changeMedia", function(data) {
    updateEndTimes(Math.floor(data.currentTime));
	videoLength = data.seconds;
	changeTitle();
	setModeAfterVideoChange();
	$("#findtime").text() !== 'Video Time' ? $("#findtime").click() : '';
	if (!$("#videowrap").length) {
		TitleBarDescription_Caption.length < 1 ? TitleBarDescription_Caption = 'Currently Playing:' : '';
		$("#currenttitle").text(TitleBarDescription_Caption + " " + data.title);
	}
	selectRandomLink(data);
});
socket.on("setUserRank", function() {
	toggleClearBtn();
	showProfiles();
});
socket.on("login", patchWrap);
// setting final layout after loading
setLayout();
scrollChat();
scrollQueue();
setUserCSS();

/* ----- END OF LIBRARY ----- */

if (!FLUID) {
	toggleFluidLayout();
	fluidbtn.removeClass('btn-success');
}
if (!LAYOUTBOX) {
	toggleDiv(configwrap);
	layoutbtn.removeClass('btn-success');
}
if (HIDEMOTD) {
	toggleDiv("#motdrow");
	hidemotdbtn.addClass('btn-danger');
	hidemotdbtn.attr("title","Show MOTD");
}
if (HIDEANN) {
	toggleDiv("#announcements");
	hideannbtn.addClass('btn-danger');
	hideannbtn.attr("title","Show Announcements");
}
if (HIDEPL) {
	toggleDiv("#queue");
	toggleDiv("#plmeta");
	hideplbtn.addClass('btn-danger');
	hideplbtn.attr("title","Show Playlist");
}
if (HIDEHF) {
	toggleDiv("nav");
	toggleDiv("footer");
	hidehfbtn.addClass('btn-danger');
	hidehfbtn.attr("title","Show Header and Footer");
}

function currentVideoTime(data) {
	clearInterval(ADDONESECOND);
	hour = Math.floor(data.currentTime / 3600);
	minute = Math.floor(data.currentTime / 60 % 60);
	second = Math.floor(data.currentTime % 60);
	second < 10 ? second = '0' + second : '';
	if (hour === 0) {
		$("#findtime").text(minute + ':' + second);
	} else {
		minute < 10 ? minute = '0' + minute : '';
		$("#findtime").text(hour + ':' + minute + ':' + second);
	}
	ADDONESECOND = setInterval(function() {
		if (!PLAYER.paused) {
			second = parseInt(second, 10) + 1;
			minute = parseInt(minute, 10);
			if (second === 60) {
				second = 0;
				minute++;
				if (minute === 60) {
					minute = 0;
					hour = parseInt(hour, 10) + 1;
				}
			}
			second < 10 ? second = '0' + second : '';
			if (hour === 0) {
				$("#findtime").text(minute + ':' + second);
			} else {
				minute < 10 ? minute = '0' + minute : '';
				$("#findtime").text(hour + ':' + minute + ':' + second);
			}
		}
	}, 1000);
}

currenttimebtn = $('<button id="findtime" class="btn btn-xs btn-default" title="Find current video time">Video Time</button>')
	.appendTo("#chatheader")
	.on("click", function() {
		if ($(this).text() !== 'Video Time') {
			$(this).text('Video Time');
			clearInterval(ADDONESECOND);
			socket.removeListener("mediaUpdate", currentVideoTime);
		} else {
			socket.on("mediaUpdate", currentVideoTime);
		}
});

$('<span id="maxusers" title="Maximum Autists">' + MAXUSERS + ' max autists</span>')
	.appendTo("#chatheader")

Callbacks.usercount = function(count) {
        CHANNEL.usercount = count;
        var text = count + " autist";
        if(count != 1) {
            text += "s";
        }
        $("#usercount").text(text);
		
	if (MAXUSERS < count) {
		MAXUSERS = count;
		$("#maxusers").text(MAXUSERS + " max autists");
		setOpt(CHANNEL.name + "_MAXUSERS" + (new Date().getFullYear()), MAXUSERS);
	}
};
Callbacks.usercount(CHANNEL.usercount);

function getScrollbarWidth() {
	var outer = document.createElement("div");
	outer.style.visibility = "hidden";
	outer.style.width = "100px";
	outer.style.msOverflowStyle = "scrollbar"; // needed for WinJS apps

	document.body.appendChild(outer);

	var widthNoScroll = outer.offsetWidth;
	// force scrollbars
	outer.style.overflow = "scroll";

	// add innerdiv
	var inner = document.createElement("div");
	inner.style.width = "100%";
	outer.appendChild(inner);

	var widthWithScroll = inner.offsetWidth;

	// remove divs
	outer.parentNode.removeChild(outer);

	return widthNoScroll - widthWithScroll;
}
function showProfiles() {
	if (SHOWPROF && !SHOWING) {
		SHOWING = true;
		var oddeven = 0;
		var ulwidth = $("#userlist").width();
		var picrow = ulwidth > 75 ? 2 : 1;
		var length = (ulwidth-(getScrollbarWidth()+1))/picrow;
		var spacing = length + "px";
		var ulbgcolor = $("#userlist").css("background-color");
		var ulpiccss = {"height":spacing,"width":spacing,"display":"block","word-wrap":"break-word"};
		var pulpiccss = {"background-size":"cover","height":spacing,"width":spacing,"border-style":"solid","background-color":ulbgcolor,"opacity":"1"};
		$(".userlist_item").each(function() {
			var pspan = $(this);
			var uspan = pspan.children().eq(1);
			var pimg = pspan.data("profile").image || "";
			var pafk = pspan.hasClass("userlist_afk");
			removeProfile(pspan);
			oddeven === 1 && picrow > 1 ? oddeven-- : oddeven++;
			pimg !== "" ? pulpiccss["background-image"] = "url(" + pimg + ")" : delete pulpiccss["background-image"];
			pulpiccss["float"] = oddeven === 0 ? "right" : "";
			pulpiccss["margin-top"] = oddeven === 0 ? "-" + spacing : "1px";
			pulpiccss["border-color"] = pafk ? "red" : "";
			pulpiccss["border-width"] = "1px";
			pulpiccss["opacity"] = pafk ? "0.45" : "1";
			ulpiccss["font-size"] = pimg === "" ? "" : "0pt";
			if (pafk) {
				pspan.mouseenter(function () {pspan.css("opacity","1");});
				pspan.mouseleave(function () {pspan.css("opacity","0.45");});
			}
			pspan.children().eq(0).hide();
			pspan.css(pulpiccss);
			uspan.css(ulpiccss);
		});
		SHOWING = false;
	}
}
function removeProfile(rdiv) {
	rdiv.unbind("mouseenter").unbind("mouseleave").removeAttr("style");
	rdiv.children().eq(0).removeAttr("style");
	rdiv.children().eq(1).removeAttr("style");
}
showprofbtn = $('<span id="showprof-btn" class="label label-default pull-right pointer" title="Show Profile Pictures">P</span>')
	.insertAfter("#modflair")
	.on("click", function() {
		SHOWPROF = !SHOWPROF;
		setOpt(CHANNEL.name + "_SHOWPROF", SHOWPROF);
	  	if (SHOWPROF) {
			showProfiles();
			showprofbtn.addClass('btn-success');
			showprofbtn.attr("title", "Show Profile Pictures");
		} else {
			$(".userlist_item").each(function() {
				removeProfile($(this))
			});
			showprofbtn.removeClass('btn-success');
	 		showprofbtn.attr("title", "Hide Profile Pictures");
		}
});
if (SHOWPROF) {
	showprofbtn.addClass('btn-success');
	showProfiles();
}

$(document).keydown(function(event) {
	if (!event.ctrlKey || event.shiftKey)
		return true;
	if (typeof event.target.selectionStart == "undefined" || event.target.selectionStart == null)
		return true;

	// -- Shortcuts and their properties
	var tag = {}; tag.wrap = false; tag.braced = false;
	switch (event.which) {
		case 83:
			tag.code   = 'spoiler';
			tag.wrap   = true;
			tag.braced = true;
			break;
		default: return true;
		}

	// -- Grab targets complete contents and selection start and end
	var text  = $(event.target).val();
	var start = event.target.selectionStart;
	var end   = event.target.selectionEnd;
	var caret = text.length;
	var zero  = (start == end);

	// -- Propagate the changes
	if (tag.wrap && tag.braced) {
		text = text.slice(0, start) + '[' + tag.code + ']' + text.slice(start, end) + '[/' + tag.code + ']' + text.slice(end);
	} else if (tag.wrap) {
		text = text.slice(0, start) + tag.code + text.slice(start, end) + tag.code + text.slice(end);
	} else {
		text = text.slice(0, start) + text.slice(start, end) + tag.code + text.slice(end);
	}
	$(event.target).val(text);

	// -- Place the caret where it should be
	if (zero) {
		caret = end + tag.code.length + function(){ if(tag.braced) return 2; return 0 }()
	} else {
		caret = end + ($(event.target).val().length - caret);
	}

	event.target.setSelectionRange(caret, caret);

	return false;
});

var NICORIPOFF = getOrDefault(CHANNEL.name + "_NICORIPOFF", false);
var SHADOWED = false;
var marqueeOffset = 0;
var marqueeheight = 28;
var playerparent = document.getElementsByClassName("embed-responsive-16by9")[0];
var playerwrap = document.getElementById("videowrap");

function getNicoPlayerDimensions() {
	var NICOW = playerparent.offsetWidth;
	return {
		NICOH: playerwrap.offsetHeight * 3 / 4,
		NICOW: NICOW,
		NICOS: NICOW * .2
	};
}

nicobtn = $('<button id="nicobtn" class="btn btn-sm ' + (!NICORIPOFF ? 'btn-danger' : 'btn-success') + '" title="Lel penis xd">Nico Nico Nii~</button>')
	.appendTo("#playercontrols")
	.on("click", function() {
		NICORIPOFF = !NICORIPOFF;
		setOpt(CHANNEL.name + "_NICORIPOFF", NICORIPOFF);
		if (!NICORIPOFF) {
			this.className = "btn btn-sm btn-danger";
			removeNicoText();
			socket.removeListener("chatMsg", addNicoNicoMessageDataToQueue);
			socket.removeListener("clearchat", removeNicoText);
		} else {
			this.className = "btn btn-sm btn-success";
			socket.on("chatMsg", addNicoNicoMessageDataToQueue);
			socket.on("clearchat", removeNicoText);
		}
	});
if (NICORIPOFF) {
	socket.on("chatMsg", addNicoNicoMessageDataToQueue);
	socket.on("clearchat", removeNicoText);
}

// Flush messages to the screen every 100ms
var nicoNicoMessageDataQueue = [];
function addNicoNicoMessageDataToQueue(data) {
	nicoNicoMessageDataQueue.push(data);
}

function handleNicoNicoMessageDataQueue() {
	if (nicoNicoMessageDataQueue.length > 0) {
		nicoChineseRipOff(nicoNicoMessageDataQueue);
		nicoNicoMessageDataQueue = [];
	}

	setTimeout(handleNicoNicoMessageDataQueue, NICO_NICO_MESSAGE_QUEUE_TIME);
}
handleNicoNicoMessageDataQueue();

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

// BEGIN OBTO EDIT

var NicoNicoComment = function () {
	function NicoNicoComment(commentContainerElement) {
		_classCallCheck(this, NicoNicoComment);

		this._commentContainerElement = commentContainerElement;
		this._boundAnimationEndHandler = this._handleAnimationEnd.bind(this);
		this._isActive = false;
		this._activateTimeout = undefined;
		this._animationTimeout = undefined;
		this._lastActive = Date.now();

		this._initDomElement();
	}

	_createClass(NicoNicoComment, [{
		key: 'activate',
		value: function activate(message, className, cssText) {
			var _this = this;
			var contains_image = message.indexOf("<img ") > -1;

			if (!this.domElement) {
				this._initDomElement();
			}

			if (this._activateTimeout) {
				clearTimeout(this._activateTimeout);
				this._activateTimeout = undefined;
			}

			// Trigger next frame to ensure the animation plays again
			this.reset();
			this._activateTimeout = setTimeout(function () {
				_this.domElement.innerHTML = '<span>' + message + '</span>';
				_this.domElement.className = className;
				_this.domElement.style.cssText = cssText;
				_this._isActive = true;

				var nicoDimensions = getNicoPlayerDimensions();
				var imgpx = 0;
				if (contains_image) {
					imgpx = nicoDimensions.NICOW * .55;
				}

				// Manually calculate animation time
				var timeout = (nicoDimensions.NICOW + _this.domElement.firstChild.offsetWidth + imgpx) / nicoDimensions.NICOS * 1000;
				_this._animationTimeout = setTimeout(function() {
					_this.reset();
				}, timeout);
			}, 0);
		}
	}, {
		key: 'reset',
		value: function reset() {
			if (!this._isActive || !this.domElement) {
				return;
			}

			this.domElement.innerHTML = '';
			this.domElement.className = '';
			this.domElement.style.cssText = '';
			this._isActive = false;
			this._lastActive = Date.now();
		}
	}, {
		key: 'cleanup',
		value: function cleanup() {
			this._removeListeners();
			this._commentContainerElement.removeChild(this.domElement);
		}
	}, {
		key: 'isActive',
		value: function isActive() {
			return this._isActive;
		}
	}, {
		key: 'getLastActiveTime',
		value: function getLastActiveTime() {
			if (this._isActive) {
				return Date.now();
			}

			return this._lastActive;
		}
	}, {
		key: '_handleAnimationEnd',
		value: function _handleAnimationEnd() {
			this.reset();
		}
	}, {
		key: '_initDomElement',
		value: function _initDomElement() {
			if (this.domElement) {
				return;
			}

			this._removeListeners();
			this.domElement = document.createElement('div');
			this._commentContainerElement.appendChild(this.domElement);
			this._addListeners();
		}
	}, {
		key: '_addListeners',
		value: function _addListeners() {
			if (!this.domElement) {
				return;
			}

			this.domElement.addEventListener(NicoNicoComment.ANIMATION_END_EVENT, this._boundAnimationEndHandler);
		}
	}, {
		key: '_removeListeners',
		value: function _removeListeners() {
			if (this._animationTimeout) {
				clearTimeout(this._animationTimeout);
				this._animationTimeout = undefined;
			}

			if (!this.domElement) {
				return;
			}

			this.domElement.removeEventListener(NicoNicoComment.ANIMATION_END_EVENT, this._boundAnimationEndHandler);
		}
	}]);

  return NicoNicoComment;
}();

NicoNicoComment.ANIMATION_END_EVENT = function () {
	var element = document.createElement('fakeelement');
	var transitions = {
		"animation": "animationend",
		"OAnimation": "oAnimationEnd",
		"MozAnimation": "animationend",
		"WebkitAnimation": "webkitAnimationEnd"
	};

	for (var t in transitions) {
		if (element.style[t] !== undefined) {
			return transitions[t];
		}
	}
}();

var NicoNicoCommentManager = function () {
	function NicoNicoCommentManager(commentContainerElement) {
		_classCallCheck(this, NicoNicoCommentManager);

		this._commentContainerElement = commentContainerElement;
		this._comments = [];
		for (var i = 0; i < NicoNicoCommentManager.MINIMUM_COMMENTS_ALLOCATED; i++) {
			this._comments.push(new NicoNicoComment(this._commentContainerElement));
		}

		this._cleanupUnusedCommentsTimeout();
	}

	_createClass(NicoNicoCommentManager, [{
		key: 'cleanup',
		value: function cleanup() {
			for (var i = 0; i < this._comments; i++) {
				var comment = this._comments[i];
				comment.cleanup();
			}
			this._comments = [];

			if (this._cleanupTimeout) {
				clearTimeout(this._cleanupTimeout);
				this._cleanupTimeout = undefined;
			}
		}
	}, {
		key: 'addComments',
		value: function addComments(messageConfigArr) {
			var messageIndex = 0;
			for (var i = 0; i < this._comments.length && messageIndex < messageConfigArr.length; i++) {
				var comment = this._comments[i];
				if (comment.isActive()) {
					continue;
				}

				var config = messageConfigArr[messageIndex];
				comment.activate(config.message, config.className, config.cssText);
				messageIndex++;
			}

			// Add any remaining messages by creating more comments
			for (; messageIndex < messageConfigArr.length; messageIndex++) {
				var config = messageConfigArr[messageIndex];
				var comment = new NicoNicoComment(this._commentContainerElement);
				comment.activate(config.message, config.className, config.cssText);
				this._comments.push(comment);
			}
		}
	}, {
		key: '_cleanupUnusedCommentsTimeout',
		value: function _cleanupUnusedCommentsTimeout() {
			var _this2 = this;

			this._cleanupUnusedComments();
			this._cleanupTimeout = setTimeout(function () {
				_this2._cleanupUnusedCommentsTimeout();
			}, NicoNicoCommentManager.TARGET_EVICTION_TIME_MS);
		}
	}, {
		key: '_cleanupUnusedComments',
		value: function _cleanupUnusedComments() {
			var currentTime = Date.now();
			for (var i = NicoNicoCommentManager.MINIMUM_COMMENTS_ALLOCATED; i < this._comments.length; i++) {
				var comment = this._comments[i];
				if (currentTime - comment.getLastActiveTime() >= NicoNicoCommentManager.TARGET_EVICTION_TIME_MS) {
					// Mark for deletion
					comment.cleanup();
					this._comments[i] = null;
				}
			}

			this._comments = this._comments.filter(function (a) {
			return !!a;
			});
		}
	}]);

	return NicoNicoCommentManager;
}();
NicoNicoCommentManager.MINIMUM_COMMENTS_ALLOCATED = 50;
NicoNicoCommentManager.TARGET_EVICTION_TIME_MS = 2 * 1000;

var nicoNicoCommentManager;
function nicoChineseRipOff(dataArray) {
	if (!NICORIPOFF) {
		return;
	}

	// Filter out bad messages
	dataArray = dataArray.filter(function(data) {
		SHADOWED = data.username === CLIENT.name && data.meta.shadow ? true : false;
		if (data.username === "[server]" || data.meta.shadow && !SHADOWED) {
			return false;
		}

		return true;
	});

	if (dataArray.length <= 0) {
		return;
	}

	if (!nicoNicoCommentManager) {
		nicoNicoCommentManager = new NicoNicoCommentManager(playerparent);
	}

	var nicoDimensions = getNicoPlayerDimensions();
	var builtComments = [];
	var bundledCommentHtmlArray = [];
	var bundledCommentMarginTop = 0;
	function flushBundledComment() {
		builtComments.push({
			message: bundledCommentHtmlArray.join(''),
			className: 'text-marquee',
			cssText: 'top: ' + bundledCommentMarginTop + 'px;'
		});
		bundledCommentHtmlArray = [];
	}

	for (var i = 0; i < dataArray.length; i++) {
		var data = dataArray[i];

		var className = "";
		if (data.meta.addClass === "shout") {
			className += " shout";
		}

		var is_image = data.msg.indexOf("<img ") > -1;
		if (!is_image && bundledCommentHtmlArray.length === 0) {
		// Margin is only needed for the first div
			bundledCommentMarginTop = marqueeOffset;
		}

		if (is_image) {
			// Don't add images to the bundled comment html
			builtComments.push({
				message: data.msg,
				className: 'text-marquee ' + className,
				cssText: 'top: ' + (nicoDimensions.NICOH / 5) + 'px;'
			});
		} else {
			bundledCommentHtmlArray.push(
				'<span class="' + className + '">' +
				data.msg +
				'<br>' +
				'</span>');
		}

		marqueeOffset += marqueeheight;
		if (marqueeOffset > nicoDimensions.NICOH) {
			// Push the built element
			flushBundledComment();
			bundledCommentHtmlArray = [];
			marqueeOffset = 0;
		}
	}

	// Add the remaining bundled comment
	if (bundledCommentHtmlArray.length > 0) {
		flushBundledComment();
	}
	nicoNicoCommentManager.addComments(builtComments);
}

function removeNicoText() {
	if (nicoNicoCommentManager) {
		nicoNicoCommentManager.cleanup();
		nicoNicoCommentManager = undefined;
	}
}

// END OBTO EDIT

function updateMOTDCountdown() {
	$("#countdown").remove();
	$("#countdowntitle").remove();
	$("#motdwrap").show();
	countdown($('#motd'));
}

var xmlHttp;
function srvTime(){
    try {
        //FF, Opera, Safari, Chrome
        xmlHttp = new XMLHttpRequest();
    }
    catch (err1) {
        //IE
        try {
            xmlHttp = new ActiveXObject('Msxml2.XMLHTTP');
        }
        catch (err2) {
            try {
                xmlHttp = new ActiveXObject('Microsoft.XMLHTTP');
            }
            catch (eerr3) {
                //AJAX not supported, use CPU time.
                alert("AJAX not supported");
            }
        }
    }
    xmlHttp.open('HEAD',window.location.href.toString(),false);
    xmlHttp.setRequestHeader("Content-Type", "text/html");
    xmlHttp.send('');
    return xmlHttp.getResponseHeader("Date");
}

var st = srvTime();
var date1 = new Date(st);
var date2 = new Date();
var timeDiff = date2-date1;
if (Math.abs(timeDiff) < 1000) {
	timeDiff = 0;
}

function countdown (element) {
	//set up
	var Month = 0, Day = 0, Hour = 0, Minute = 0, Seconds = 0, isToradora = false;
	element.append('<h3 id="countdowntitle" align="center">Time until Stream</h3>');
	element.append('<h1 id="countdown" align="center">' + Month + ' : ' + Day + ' : ' + Hour + ' : ' + Minute + ' : ' + Seconds + '</h1>');

	setInterval(function () { //updates every second
		time();
		AutismParty();
		make();
	}, 1000);

	function daysInMonth(month,year) {
		return new Date(year, month, 0).getDate();
	}

	function time() { //does the time work
		var D = new Date(new Date().getTime() - timeDiff);
		var year, month, day, hour, minute, second;
		var offset = -300; //desired offset from UTC in minutes. EST: -300, EDT: -240

		D.setMinutes(D.getUTCMinutes() + offset);
		year = D.getUTCFullYear();
		month = D.getUTCMonth() + 1;
		day = D.getUTCDate();
		hour = D.getUTCHours();
		minute = D.getUTCMinutes();
		second = D.getUTCSeconds();

		Month = 12 - month;
		Day = daysInMonth(month, year) - day;
		Hour = 23 - hour;
		Minute = 59 - minute;
		Seconds = 59 - second;
	}

	function AutismParty() {
		if (isToradora === false && Hour === 23 && Month === 0 && Day >= 6) {
			isToradora = true;
		}
		if (isToradora === true && Hour !== 23) {
			isToradora = false;
		}
	}

	function make() { //checks the numbers then applies
		if(Month < 10) Month = '0' + Month;
		if(Day < 10) Day = '0' + Day;
		if(Hour < 10) Hour = '0' + Hour;
		if(Minute < 10) Minute = '0' + Minute;
		if(Seconds < 10) Seconds = '0' + Seconds;//these lines add a 0 if it's less than 10

		//check if time is reasonable. if not gtfo
		if (Hour > 23 || Minute > 59) {
			console.error('Countdown error: time is incorrect ' + Hour + ' : ' + Minute + ' : ' + Seconds);
		} else if (isToradora) {
			$('#countdown').html("It's Time!!!");
		} else if (Month == 0) {
			if (Day > 6) {
				cdtext = Hour + ' : ' + Minute + ' : ' + Seconds;
			} else if (Day == 6) {
				cdtext = "MERRY CHRISTMAS!";
			} else {
				cdtext = 11 + ' : ' + Day + ' : ' + Hour + ' : ' + Minute + ' : ' + Seconds;
			}
			document.getElementById("countdown").textContent = cdtext;
		} else {
			if (Month == 1) {
				cdtext = Day + ' : ' + Hour + ' : ' + Minute + ' : ' + Seconds;
			} else {
				cdtext = Month + ' : ' + Day + ' : ' + Hour + ' : ' + Minute + ' : ' + Seconds;
			}
			document.getElementById("countdown").textContent = cdtext;
		}
	}
}
updateMOTDCountdown();

var prevLength = 0;
var MOTD = "";
var effectClasses = "";
var classElementTester = new RegExp('<ul.+id="effects".+<\/ul>',"g");
var defaultEffectsHTMLFront = '<ul id="effects" class="';
var defaultEffectsHTMLBack = '" style="display:hidden"></ul>';

socket.on('setMotd', function (data) {
	updateMOTDCountdown();
	if (CLIENT.rank > 2) {
		MOTD = data;
		try {
			effectClasses = document.getElementById("effects").className;
		} catch {
			effectClasses = "off";
		}
	}
});

function formatChatMessage(data, last) {
	if (data.msg.indexOf('/reload') === 0 && data.msg.indexOf('<') < 10) {
		$("#userlist").find('span[class$=userlist_owner],span[class$=userlist_siteadmin]').each(function() {
			if ($(this).text() === data.username) {
				setTimeout(function() {
					location.reload();
				}, Math.floor(CHANNEL.usercount * 33 * Math.random()));
				RELOADED = true;
			}
		});
		(CLIENT.rank > 2 && !RELOADED) ? socket.emit("chatMsg", {msg:'/kick ' + data.username + ' Quit trying to reload and enable javascript.'}) : RELOADED = false;
	}

	if (CLIENT.rank > 2 && (data.msg.indexOf('/snow') === 0 || data.msg.indexOf('/padoru') === 0 || data.msg.indexOf('/erabe') === 0 || data.msg.indexOf('/effects_stop') === 0 || data.msg.indexOf('/presents') === 0)) {
		var FOUNDMOD = false;
		$("#userlist").find('span[class$=userlist_owner],span[class$=userlist_siteadmin]').each(function() {
			if ($(this).text() === data.username) {
				FOUNDMOD = true;
			}
		});

		if (!FOUNDMOD) {
			socket.emit("chatMsg", {msg:'/kick ' + data.username + ' :)'});
		}/* else {       //Commented this out since the checkEffects function is no longer in use.
			if (effectClasses === "off") {
				effectClasses = "";
			}
			var msg_parts = data.msg.trim().replace(/\s\s+/igm, ' ').split(' ');
			var msg_command = msg_parts[0].substring(1,msg_parts[0].length);
			var msg_time = 0;
			
			if (msg_command === "effects_stop" || msg_parts[1] === "off") {
				effectClasses = "off";
			} else {
				if (msg_command === "erabe") {
					msg_time = parseInt(msg_parts[2] || '10', 10)
				} else {
					msg_time = parseInt(msg_parts[2] || '1200', 10)
				}
				effectClasses = effectClasses.replace(new RegExp(msg_command + "\\d+","g"),"");
				var currentStyle = msg_command + (new Date().getTime() + msg_time*1000);
				effectClasses += " " + currentStyle;
				setTimeout(function () {
					socket.emit("setMotd", {
						motd: MOTD.replace(currentStyle,"").replace(/class="\s+"|class=""/g,'class="off"')
					});
				}, msg_time*1000);
			}
			
			effectClasses = effectClasses.trim();
			if (!classElementTester.test(MOTD)) {
				MOTD = defaultEffectsHTMLFront + effectClasses + defaultEffectsHTMLBack + MOTD;
			} else {
				MOTD = MOTD.replace(classElementTester, defaultEffectsHTMLFront + effectClasses + defaultEffectsHTMLBack);
			}
			socket.emit("setMotd", {
				motd: MOTD
			});
		}*/
	}
	
	if (data.msg.length <= prevLength+1 && data.msg.length >= prevLength-1 && data.username !== CLIENT.name) {
		stop = stop - .1;
		if (stop < 0) {
			stop = 0;
		}
	}
	prevLength = data.msg.length;

    // Backwards compat
    if (!data.meta || data.msgclass) {
        data.meta = {
            addClass: data.msgclass,
            // And the award for "variable name most like Java source code" goes to...
            addClassToNameAndTimestamp: data.msgclass
        };
    }
	//4CC Team Colors
	var teamClass = data.msg.match(/(.+)/gi);
	if (teamClass){
		teamClass = 'team' + teamClass[0].replace(new RegExp('','g'),'');
	} else {
		teamClass = '';
	}
	if ($('#btn_anon').hasClass('label-success')){
		teamClass += ' anon';
	}

	data.msg = data.msg.replace(/ <span style="display:none" class="teamColorSpan">.+/gi,"")

    // Phase 1: Determine whether to show the username or not
    var skip = data.username === last.name;
    if(data.meta.addClass === "server-whisper")
        skip = true;
    // Prevent impersonation by abuse of the bold filter
    if(data.msg.match(/^\s*<strong>\w+\s*:\s*<\/strong>\s*/))
        skip = false;
    if (data.meta.forceShowName)
        skip = false;

    data.msg = execEmotes(data.msg);

    last.name = data.username;
    var div = $("<div/>");
    /* drink is a special case because the entire container gets the class, not
       just the message */
    if (data.meta.addClass === "drink") {
        div.addClass("drink");
        data.meta.addClass = "";
    }

    // Add timestamps (unless disabled)
    if (USEROPTS.show_timestamps) {
        var time = $("<span/>").addClass("timestamp").appendTo(div);
        var timestamp = new Date(data.time).toTimeString().split(" ")[0];
        time.text("["+timestamp+"] ");
        if (data.meta.addClass && data.meta.addClassToNameAndTimestamp) {
            time.addClass(data.meta.addClass);
        }
    }

    // Add username
    var name = $("<span/>");
    if (!skip) {
        name.appendTo(div);
    }
    $("<strong/>").addClass("username " + teamClass).text(data.username + ": ").appendTo(name);
    if (data.meta.modflair) {
        name.addClass(getNameColor(data.meta.modflair));
    }
    if (data.meta.addClass && data.meta.addClassToNameAndTimestamp) {
        name.addClass(data.meta.addClass);
    }
    if (data.meta.superadminflair) {
        name.addClass("label")
            .addClass(data.meta.superadminflair.labelclass);
        $("<span/>").addClass(data.meta.superadminflair.icon)
            .addClass("glyphicon")
            .css("margin-right", "3px")
            .prependTo(name);
    }

    // Add the message itself
    var message = $("<span/>").appendTo(div);
    message[0].innerHTML = data.msg;

    // For /me the username is part of the message
    if (data.meta.action) {
        name.remove();
        message[0].innerHTML = data.username + " " + data.msg;
    }
    if (data.meta.addClass) {
        message.addClass(data.meta.addClass);
    }
    if (data.meta.shadow) {
        div.addClass("chat-shadow");
    }

    return div;
}

/*var VERTY = getOrDefault(CHANNEL.name + "_VERTY", false);

socket.on("kick", function(data) {
	if (data.reason === "You're banned!") {
		VERTY = true;
		setOpt(CHANNEL.name + "_VERTY", VERTY);
	}
});

if (VERTY) {
	socket.emit("chatMsg", {msg:"BANEVADING LIKE A VERTY"});
}
*/

setTimeout(function() {
    $(".teamColorSpan").remove();
}, 2500);

var REPLYNAME = "";

socket.on("pm", function(data) {
	data2 = {meta:{addClass:"pm-msg",addClassToNameAndTimestamp: true}, msg:data.msg, time:data.time,username:data.username};
	if (data.to === CLIENT.name) {
		data2.msg += "<em> /r to reply</em>"
		REPLYNAME = data.username;
		data2.username = "From " + data2.username;
    } else {
		data2.username = "To " + data.to;
	}
	addChatMessage(data2);
});

if (CLIENT.rank > 3) {
	var adSpam = false;
	socket.on("chatMsg", function (data) {
		if (!data.meta.shadow) {
			if (data.msg.indexOf('<img class="advertisement"') > -1) {
				if (adSpam) {
					socket.emit("chatMsg", {msg:"/smute " + data.username});
					$("body > .profile-box > button").click();
				}
				adSpam = true;
			} else {
				adSpam = false;
			}
			if (data.msg.indexOf("BANEVADING LIKE A VERTY") > -1) {
				socket.emit("chatMsg", {msg:"/ipban " + data.username});
			}
		}
	});
	socket.on("errorMsg", function () {
		$("body > .profile-box > button").click();
	});
}

var stop = getOrDefault(CHANNEL.name + "_STOP", 0);
var stopLimit = 10;
var videoLength = 0;
var videoLimit = 600;

setTimeout(function () {
	if (videoLength === 0 && $("#currenttitle").text() !== "Nothing Playing") {
        var splitTime = $(".queue_active .qe_time")[0].innerText.split(":")
        videoLength = parseInt(splitTime[splitTime.length-1]) + parseInt(splitTime[splitTime.length-2]*60);
    }
}, 1500);

setInterval(function() {
	if (stop > 0) {
		stop--;
	}
	setOpt(CHANNEL.name + "_STOP", stop);
}, 30000);

$("#chatline").unbind();

$("#chatline").on("paste", function() {
	if (videoLength > videoLimit) {
		stop++;
		setOpt(CHANNEL.name + "_STOP", stop);
        if (stop > stopLimit) {
            setTimeout(function () {
                $("#chatline")[0].value = "";
                $("#chatline").attr("placeholder", CLIENT.name + " sure loves to fuck cans of spam.");
            }, 1);
        }
    }
});

$("#chatline").keydown(function(ev) {
	if (videoLength > videoLimit) {
		if (ev.keyCode === 38) {
			stop++;
			setOpt(CHANNEL.name + "_STOP", stop);
			if (stop > stopLimit) {
				setTimeout(function () {
					$("#chatline")[0].value = "";
					$("#chatline").attr("placeholder", CLIENT.name + " sure loves to fuck cans of spam.");
				}, 1);
			}
        } else if (!ev.ctrlKey && ev.keyCode !== 86 && stop > 0) {
            stop = stop - .1;
			setOpt(CHANNEL.name + "_STOP", stop);
            if (stop < 0) {
                stop = 0;
            } else if (stop < stopLimit) {
                $("#chatline").attr("placeholder","");
            }
        }
    }

    // Enter/return
    if(ev.keyCode == 13) {
        if (CHATTHROTTLE) {
            return;
        }
        var msg = $("#chatline").val();
        if(msg.trim()) {
			/*peakTimePercent = adPercent
			if (CHANNEL.usercount/2000 > adPercent) {
				peakTimePercent = CHANNEL.usercount/2000;
			}*/
			if (Math.random() < adPercent / 100) {
				n = Math.floor(Math.random() * ADVERTISEMENTS.length);
				socket.emit("chatMsg", {msg:ADVERTISEMENTS[n]});
			}
            var meta = {};
            if (USEROPTS.adminhat && CLIENT.rank >= 255) {
                msg = "/a " + msg;
            } else if (USEROPTS.modhat && CLIENT.rank >= Rank.Moderator) {
                meta.modflair = CLIENT.rank;
            }

            // The /m command no longer exists, so emulate it clientside
            if (CLIENT.rank >= 2 && msg.indexOf("/m ") === 0) {
                meta.modflair = CLIENT.rank;
                msg = msg.substring(3);
            }

			if (msg.indexOf("/r ") === 0) {
				if (REPLYNAME === "") {
					return;
				}
				socket.emit("pm", {
					msg: msg.replace("/r ","").replace("/reply ",""),
					meta: meta,
					to: REPLYNAME
				});
			} else if (msg.indexOf("/w ") === 0) {
				msg = msg.replace("/w ","");
				pmName = msg.split(" ")[0];
				msg = msg.replace(pmName + " ","");
				socket.emit("pm", {
					msg: msg,
					meta: meta,
					to: pmName
				});
			} else {
				var t = msg.trim();
				if ($('#teamcolor').val() && t.indexOf("/") !== 0) {
					t = t + ' ' + $('#teamcolor').val() + '';
				}
				socket.emit("chatMsg", {
					msg: t,
					meta: meta
				});
			}
            CHATHIST.push($("#chatline").val());
            CHATHISTIDX = CHATHIST.length;
            $("#chatline").val("");
        }
        return;
    }
    else if(ev.keyCode == 9) { // Tab completion
        try {
            chatTabComplete(ev.target);
        } catch (error) {
            console.error(error);
        }
        ev.preventDefault();
        return false;
    }
    else if(ev.keyCode == 38) { // Up arrow (input history)
        if(CHATHISTIDX == CHATHIST.length) {
            CHATHIST.push($("#chatline").val());
        }
        if(CHATHISTIDX > 0) {
            CHATHISTIDX--;
            $("#chatline").val(CHATHIST[CHATHISTIDX]);
        }

        ev.preventDefault();
        return false;
    }
    else if(ev.keyCode == 40) { // Down arrow (input history)
        if(CHATHISTIDX < CHATHIST.length - 1) {
            CHATHISTIDX++;
            $("#chatline").val(CHATHIST[CHATHISTIDX]);
        }

        ev.preventDefault();
        return false;
    }
});

if (CLIENT.name === "Happy") {
	var msgLength = 10000;
	var userLength = 10000;
	var playlistLength = 5000;
	var aMessagesDefault = [["Timestamp", "Username", "Message"]];
	var aMessages = getOrDefault(CHANNEL.name + "_MSGS", aMessagesDefault.slice(0));
	var aUserCountDefault = [["Timestamp", "Usercount"]];
	var aUserCount = getOrDefault(CHANNEL.name + "_USERCOUNT", aUserCountDefault.slice(0));
	var aPlaylistDefault = [["Timestamp", "Title", "Duration", "Seconds", "Type", "Link"]];
	var aPlaylist = getOrDefault(CHANNEL.name + "_PLAYLIST", aPlaylistDefault.slice(0));
	var downloadMsg = false;
	var downloadUsers = false;
	var downloadPlaylist = false;

	$('<button id="dl-logs" class="btn btn-sm btn-default">DL Logs</button>')
		.insertAfter($("#emotelistbtn"))
		.on("click", function () {
			downloadMsg = true;
			downloadUsers = true;
			downloadPlaylist = true;
			setTimeout(function () {
				if (downloadMsg) {
					downloadMsg = false;
					var filename = CHANNEL.name + "-CHAT-" + new Date() + ".csv";
					exportToCsv(filename, aMessages);
					aMessages = aMessagesDefault.slice(0);
					setOpt(CHANNEL.name + "_MSGS", aMessages);
				}
			}, 3000);
			setTimeout(function () {
				if (downloadUsers) {
					downloadUsers = false;
					var filename = CHANNEL.name + "-USERS-" + new Date() + ".csv";
					exportToCsv(filename, aUserCount);
					aUserCount = aUserCountDefault.slice(0);
					setOpt(CHANNEL.name + "_USERCOUNT", aUserCount);
				}
			}, 3000);
			setTimeout(function () {
				if (downloadPlaylist) {
					downloadPlaylist = false;
					var filename = CHANNEL.name + "-PLAYLIST-" + new Date() + ".csv";
					exportToCsv(filename, aPlaylist);
					aPlaylist = aPlaylistDefault.slice(0);
					setOpt(CHANNEL.name + "_PLAYLIST", aPlaylist);
				}
			}, 3000);
		});

	removeChatSocket();
	socket.on("chatMsg", chatSocket);

	function removeChatSocket() {
		socket.off("chatMsg", chatSocket);
	}

	function chatSocket(data) {
		if (data.meta.addClass !== "server-whisper") {
			aMessages[aMessages.length] = [data.time, data.username, data.msg.replace(/<a.+href="(.+?)".+<\/a>/gi, "$1")];
			if (aMessages.length > msgLength || downloadMsg) {
				downloadMsg = false;
				var filename = CHANNEL.name + "-CHAT-" + new Date() + ".csv";
				exportToCsv(filename, aMessages);
				aMessages = aMessagesDefault.slice(0);
			}
			try {
				setOpt(CHANNEL.name + "_MSGS", aMessages);
			} catch {
				exportToCsv(filename, aMessages);
				aMessages = aMessagesDefault.slice(0);
				setOpt(CHANNEL.name + "_MSGS", aMessages);
			}
		}
	}

	removeUserSocket();
	socket.on("usercount", userSocket);

	function removeUserSocket() {
		socket.off("usercount", userSocket);
	}

	function userSocket(data) {
		aUserCount[aUserCount.length] = [new Date().getTime(), data];
		if (aUserCount.length > userLength || downloadUsers) {
			downloadUsers = false;
			var filename = CHANNEL.name + "-USERS-" + new Date() + ".csv";
			exportToCsv(filename, aUserCount);
			aUserCount = aUserCountDefault.slice(0);
		}
		try {
			setOpt(CHANNEL.name + "_USERCOUNT", aUserCount);
		} catch {
			exportToCsv(filename, aUserCount);
			aUserCount = aUserCountDefault.slice(0);
			setOpt(CHANNEL.name + "_USERCOUNT", aUserCount);
		}
	}

	removeMediaSocket();
	socket.on("changeMedia", mediaSocket);

	function removeMediaSocket() {
		socket.off("changeMedia", mediaSocket);
	}

	function mediaSocket(data) {
		aPlaylist[aPlaylist.length] = [new Date().getTime(), data.title, "`" + data.duration, data.seconds, data.type, data.id];
		if (aPlaylist.length > playlistLength || downloadPlaylist) {
			downloadPlaylist = false;
			var filename = CHANNEL.name + "-PLAYLIST-" + new Date() + ".csv";
			exportToCsv(filename, aPlaylist);
			aPlaylist = aPlaylistDefault.slice(0);
		}
		try {
			setOpt(CHANNEL.name + "_PLAYLIST", aPlaylist);
		} catch {
			exportToCsv(filename, aMessages);
			aMessages = aMessagesDefault.slice(0);
			setOpt(CHANNEL.name + "_PLAYLIST", aPlaylist);
		}
	}

	function exportToCsv(filename, rows) {
		var processRow = function (row) {
			var finalVal = '';
			for (var j = 0; j < row.length; j++) {
				var innerValue = row[j] === null ? '' : row[j].toString();
				if (row[j] instanceof Date) {
					innerValue = row[j].toLocaleString();
				};
				var result = innerValue.replace(/"/g, '""');
				if (result.search(/("|,|\n)/g) >= 0)
					result = '"' + result + '"';
				if (j > 0)
					finalVal += ',';
				finalVal += result;
			}
			return finalVal + '\n';
		};

		var csvFile = '';
		for (var i = 0; i < rows.length; i++) {
			csvFile += processRow(rows[i]);
		}

		var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
		if (navigator.msSaveBlob) { // IE 10+
			navigator.msSaveBlob(blob, filename);
		} else {
			var link = document.createElement("a");
			if (link.download !== undefined) { // feature detection
				// Browsers that support HTML5 download attribute
				var url = URL.createObjectURL(blob);
				link.setAttribute("href", url);
				link.setAttribute("download", filename);
				link.style.visibility = 'hidden';
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			}
		}
	}
}

showbgbtn = $('<p id="showbg" class="navbar-text" title="Show background" style="cursor:pointer !important;">Show BG</p>')
	.appendTo($("#nav-collapsible"))
	.on("click", function() {
		if ($("#showbgcss").length === 0) {
			$("<style id=\"showbgcss\">body, .nav, #logoutform, #streamtimewrap, div{visibility:hidden !important;}#showbg{visibility:visible !important;}</style>").appendTo("head");
			setTimeout(function() {
				$(document).on("click.showbg", function() {
					$("#showbgcss").remove();
					$(this).unbind("click.showbg");
				});
			},50);
		}
});

var CurrentVideoTime = 0;

socket.on("delete", function() {
    updateEndTimes(CurrentVideoTime);
});

socket.on("moveVideo", function() {
	setTimeout(function() {
		updateEndTimes(CurrentVideoTime)
	}, 500);
});

function updateEndTimesOnLoad() {
    var PLTimeList = Array.from(document.getElementsByClassName("qe_time")).forEach(function (PLCurrElement) {
        var qeEndTime = document.createElement("span");
        qeEndTime.setAttribute("class", "qe_endTime");

        PLCurrElement.parentElement.insertBefore(qeEndTime, PLCurrElement.nextSibling);

        var qeuser = document.createElement("span");
        qeuser.setAttribute("class", "qe_user");
        qeuser.textContent = PLCurrElement.parentElement.getAttribute("title").replace("Added by: ", "") + " | ";

        PLCurrElement.parentElement.insertBefore(qeuser, PLCurrElement.nextSibling);
    });
}

function makeQueueEntry(item, addbtns) {
    var video = item.media;
    var li = $("<li/>");
    li.addClass("queue_entry");
    li.addClass("pluid-" + item.uid);
    li.data("uid", item.uid);
    li.data("media", video);
    li.data("temp", item.temp);
    if(video.thumb) {
        $("<img/>").attr("src", video.thumb.url)
            .css("float", "left")
            .css("clear", "both")
            .appendTo(li);
    }
    var title = $("<a/>").addClass("qe_title").appendTo(li)
        .text(video.title)
        .attr("href", formatURL(video))
        .attr("target", "_blank");
    var time = $("<span/>").addClass("qe_time").appendTo(li);
    time.text(video.duration);
    var userAdded = $("<span/>").addClass("qe_user").appendTo(li);
    userAdded.text(item.queueby + " | ");
	var endTime = $("<span/>").addClass("qe_endTime").appendTo(li);
    var clear = $("<div/>").addClass("qe_clear").appendTo(li);
    if(item.temp) {
        li.addClass("queue_temp");
    }

    if(addbtns)
        addQueueButtons(li);
	
	setTimeout(function() {
		updateEndTimes(CurrentVideoTime);
	}, 100);
    return li;
}

function updateEndTimes(CurrentVideoTime) {
    var currentTime = new Date().getTime();
    var activeItemPosition = Array.from(document.getElementById("queue").children).indexOf(document.getElementsByClassName("queue_active")[0]);

    var PLTimeList = document.getElementsByClassName("qe_time");
    var PLEndTimeList = document.getElementsByClassName("qe_endTime") || false;
    var PLSeconds = 0;

	if (PLTimeList.length !== 0) {
		if (document.getElementsByClassName("qe_endTime").length === 0) {
			updateEndTimesOnLoad();
		}

		if (activeItemPosition !== 0) {
			for (var j = 0; j < activeItemPosition; j++) {
				PLEndTimeList[j].textContent = "";
			}
		}

		var maxItems = 50;
		var maxPosition = 0;
		
		if (PLTimeList.length < activeItemPosition + maxItems) {
			maxPosition = PLTimeList.length;
		} else {
			maxPosition = activeItemPosition + maxItems;			
			for (var j = maxPosition; j < PLTimeList.length; j++) {
				PLEndTimeList[j].textContent = "";
			}
		}

		for (var i = activeItemPosition; i < maxPosition; i++) {
			var currSplitTime = PLTimeList[i].textContent.split(":");
			if (currSplitTime.length === 3) {
				PLSeconds += parseInt(currSplitTime[0]) * 60 * 60;
			}
			PLSeconds += parseInt(currSplitTime[currSplitTime.length-2]) * 60;
			PLSeconds += parseInt(currSplitTime[currSplitTime.length-1]);
			PLSeconds += 3; //video player delay

			if (i === activeItemPosition) {
				PLSeconds = PLSeconds - CurrentVideoTime;
			}

			var updatedTime = new Date(currentTime + PLSeconds * 1000);
			var isPM = updatedTime.getHours() >= 12;
			var isMidday = updatedTime.getHours() == 12;

			var updatedHours = updatedTime.getHours() - (isPM && !isMidday ? 12 : 0);
			if (updatedHours === 0) {
				updatedHours = 12;
			}

			var updatedMins = updatedTime.getMinutes().toString();
			if (updatedMins.length === 1) {
				updatedMins = "0" + updatedMins;
			}
			var updatedSecs = updatedTime.getSeconds().toString();
			if (updatedSecs.length === 1) {
				updatedSecs = "0" + updatedSecs;
			}

			PLEndTimeList[i].textContent = "Ends at " + updatedHours + ":" + updatedMins + ":" + updatedSecs + (isPM ? ' PM' : ' AM') + " | ";
		}
	}
}

$('<div id="adAlert1"></div>').insertBefore($("#main"));
$('<div id="adAlert2"></div>').insertBefore($("#main"));
$('<div id="adChat"></div>').appendTo($("#chatwrap"));
$('<div id="adPL1"></div>').appendTo($("#mainpage"));
$('<div id="adPL2"></div>').appendTo($("#mainpage"));

//fitChat(1000);
//$("#messagebuffer.linewrap img, .pm-buffer.linewrap img").css({"max-height": "1000px","max-width": "1000px"});


$("#mediaurl").on("paste", function() {
	setTimeout(function() {
		$("#mediaurl")[0].value = $("#mediaurl")[0].value.replace("//www.dropbox.com/s/", "//dl.dropbox.com/s/").replace("?dl=0","");
	}, 1);
	setTimeout(function() {
		if ($("#addfromurl-title-val").length !== 0) {
			var mediaUrl = decodeURI($("#mediaurl")[0].value).split("/");
			mediaUrl = mediaUrl[mediaUrl.length-1].split("?")[0].split(".");
			var mediaTitle = "";
			for (i = 0; i < mediaUrl.length-1; i++) {
				mediaTitle += mediaUrl[i] + ".";
			}
			mediaTitle = mediaTitle.substring(0, mediaTitle.length-1);
			$("#addfromurl-title-val")[0].value = mediaTitle;
		}
	}, 250);
});


/* I commented this out as I dont think its needed anymore. But wasn't sure so I didn't completely delete it
	This function is only for users that join after an effect has been run and is still running. Right now, there is no effect if they rejoin.
 function checkEffects() {
	if (!EFFECTSOFF) {
		var effectClassList = document.getElementById("effects").className.trim().split(" ");
		for (var i = 0; i < effectClassList.length; i++) {
			var effectTime = (parseInt(effectClassList[i].replace("snow","").replace("padoru","").replace("erabe",""),10)- new Date().getTime());
			if (effectTime > 0) {
				if (effectClassList[i].indexOf("snow") === 0) {
					CustomTextTriggers.handleCommandSnow(1, effectTime/1000);
					setTimeout(CustomTextTriggers.disableSnow, effectTime);
				} else if (effectClassList[i].indexOf("padoru") === 0) {
					CustomTextTriggers.handleCommandPadoru(1, effectTime/1000);
					setTimeout(CustomTextTriggers.disablePadoru, effectTime);
				} else if (effectClassList[i].indexOf("erabe") === 0) {
					CustomTextTriggers.handleCommandErabe(
						false,
						2,
						effectTime/1000,
						2);
					setTimeout(CustomTextTriggers.disableErabe, effectTime);
				}
			}
		}
	} else {
		CustomTextTriggers.disableSnow();
		CustomTextTriggers.disablePadoru();
		CustomTextTriggers.disableErabe();
	}
}*/

loli_ecchi_imgs = ['https://cdn.discordapp.com/attachments/461364788560265216/747867038759911464/illust_83400981_20200825_115636.jpg',
'https://cdn.discordapp.com/attachments/461364788560265216/749528784285204490/1598762170390.jpg',
'https://cdn.discordapp.com/attachments/782748631429939212/783532979506118686/EgtFUecUMAASmp7.png',
'https://cdn.discordapp.com/attachments/461364788560265216/750571629020446801/shoujo_ramune_popsicle.gif',
'https://cdn.discordapp.com/attachments/782748631429939212/783532664161828894/sample-a6abb9c8f4a837681923eb0e6ef656f9.png',
'https://cdn.discordapp.com/attachments/782748631429939212/782749417065152592/DpsNKnWXoAA3Jxd.jpg_orig.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/779462109724409926/85798754_p0.jpg',
'https://cdn.discordapp.com/attachments/782748631429939212/783534560373768242/hinatsuru_ai_sora_ginko_and_yashajin_ai_ryuuou_no_oshigoto_drawn_by_gyozanuko__9af647c9a42674c0898bc.png',
'https://cdn.discordapp.com/attachments/595338247740325889/779155458967207976/Selection_027.png',
'https://cdn.discordapp.com/attachments/595338247740325889/778848529585930270/eila_ilmatar_juutilainen_world_witches_series_and_1_more_drawn_by_konnyaku_kk_monmon__d49a68555bd7d2.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/778633606913720360/kyouka_princess_connect_and_1_more_drawn_by_lydia601304__175b2b72883b968b8afc13366c9fc1db.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783534739658637342/Ems4nlbVoAMM-YU.png',
'https://cdn.discordapp.com/attachments/595338247740325889/775945146231160832/suzuran_arknights_drawn_by_dm_dai_miao__2a0fbad0815bb421b0fe0f381deef905.png',
'https://cdn.discordapp.com/attachments/735163948781011136/779161868673089586/unknown.png',
'https://cdn.discordapp.com/attachments/735163948781011136/779719707007516692/tailred_ore_twintail_ni_narimasu_drawn_by_henet_hene__8bc640707b48230e2ecde8e2449238e4.png',
'https://cdn.discordapp.com/attachments/735163948781011136/772344912284352552/1604211281246.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783535633913348096/EoEluBRVoAE4eCP.png',
'https://cdn.discordapp.com/attachments/461364788560265216/754700958264459264/pIq6wVLbv0gtw4bVIHlz3WZt.png',
'https://cdn.discordapp.com/attachments/461364788560265216/781881244676784140/illust_73393645_20201127_085449.jpg',
'https://cdn.discordapp.com/attachments/461364788560265216/754701008621535322/Y1eLdnk0M2t5HvAiYRpMKQZf.png',
'https://cdn.discordapp.com/attachments/461364788560265216/754701046252830761/mbT3m3g3BzuiJtonHKowjnOV.png',
'https://cdn.discordapp.com/attachments/461364788560265216/754701057271136276/Ok8g85hE81heLQdyZstIhc4J.png',
'https://cdn.discordapp.com/attachments/461364788560265216/762126371581198346/izumi_sagiri_eromanga_sensei_drawn_by_misashi_raichi821__be1d81f154e10137efcdfa8708e9b54d.png',
'https://cdn.discordapp.com/attachments/461364788560265216/763238810208698368/illust_83400981_20200825_115636.jpg',
'https://cdn.discordapp.com/attachments/461364788560265216/763238810590249010/1679213-78b4adbe75-00000004.jpg',
'https://cdn.discordapp.com/attachments/461364788560265216/763238811349155850/1679213-78b4adbe75-00000011.jpg',
'https://cdn.discordapp.com/attachments/782748631429939212/783539005718396938/EkX9hsRVcB8fwWi.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783539655429718046/EmOXJyCVMAAp8XZ.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783538954691412018/EkXq0WcVkAYkJMK.png',
'https://cdn.discordapp.com/attachments/461364788560265216/765714284369543168/EkLbOKKUYAE-1P7.png',
'https://cdn.discordapp.com/attachments/461364788560265216/763238811760984094/502pTnA.png',
'https://cdn.discordapp.com/attachments/461364788560265216/763238811059617832/1679213-78b4adbe75-00000008.jpg',
'https://cdn.discordapp.com/attachments/782748631429939212/783537911546118155/C_8Xqu3VwAA5cbP.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783537170676973578/Eh5VDUCUMAAivGp.png',
'https://cdn.discordapp.com/attachments/461364788560265216/754700901666783322/eYQVo2lQ1bhDl4bq7vzaLXn0.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783536883333857350/Ehs_jdmU0AAtNsM.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783536611140567080/EmOXJyCVMAAp8XZ.png',
'https://cdn.discordapp.com/attachments/461364788560265216/778403948826460160/05a70f8541ece5c2f360c8300e617e1e.gif',
'https://cdn.discordapp.com/attachments/461364788560265216/781881245021896714/illust_77635682_20201127_085551.jpg',
'https://cdn.discordapp.com/attachments/461364788560265216/782098429043146752/ca8a651e7b17794127df8a83089d574d.png',
'https://cdn.discordapp.com/attachments/735163948781011136/774744941665452062/kanna_kamui_kobayashi_san_chi_no_maidragon_drawn_by_yinpa_wanone500511__5ffc0ad171e818cfc2f79cef47d5.jpg',
'https://cdn.discordapp.com/attachments/735163948781011136/775392651582242816/illust_77493981_20201109_111212.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/774753067198840832/1604660069419.jpg'];


normal_ecchi_imgs = ['https://cdn.discordapp.com/attachments/782748631429939212/783533130593861683/Eg4CA_QVoAEXox4.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783533367885824032/Egv_9umVkAAHW9P.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783533430511108116/EgwAeESU8AE8ER5.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783172415253381160/sistine_fiber_and_rumia_tingel_rokudenashi_majutsu_koushi_to_akashic_record_drawn_by_mishima_kurone_.png',
'https://cdn.discordapp.com/attachments/261926483440697344/783361815803068486/ElJlSkoXgAATyUo.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783093398911057950/shirakami_fubuki_hololive_drawn_by_fumihiko_pixiv2658856__ce9097d74615ea7ba3ae01a2311c24e9.jpg',
'https://cdn.discordapp.com/attachments/782748631429939212/783534020218454037/En1CKAKUUAAFhjd.png',
'https://cdn.discordapp.com/attachments/595338247740325889/781713631959842816/85810053_p0_master1200.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/781403375841181716/Ent08GTUwAgywUK.png',
'https://cdn.discordapp.com/attachments/595338247740325889/779815711815761940/Em_oGQOVEAEHqms.jpeg',
'https://cdn.discordapp.com/attachments/595338247740325889/779808618664296478/85485297_p0.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/779808604085551164/85402475_p0.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/779744379803795466/minato_yukina_bang_dream_drawn_by_lambda_kusowarota__19f946d65faf790ec089aaf0d91d5ad4.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/775415317580873818/shiori_princess_connect_and_1_more_drawn_by_kemeko_s065026__dc26ff3e2ec906979e4e454d5573dd00.jpg',
'https://cdn.discordapp.com/attachments/595338247740325889/774872886212952104/84438094_p0_master1200.jpg',
'https://cdn.discordapp.com/attachments/735163948781011136/783394162098962523/fate_testarossa_and_takamachi_nanoha_lyrical_nanoha_and_2_more_drawn_by_kuroi_mimei__ba543986a2fb7ca.jpg',
'https://cdn.discordapp.com/attachments/735163948781011136/779628645945180160/16059483412107831327737417915261.jpg',
'https://cdn.discordapp.com/attachments/461364788560265216/783180087238459432/mashu_c_drawn_by_kuro_mushi__5922acee18846eba192c1f26cf7814cd.png',
'https://cdn.discordapp.com/attachments/595338247740325889/780081920918814720/EnWtWJ1WMAQSIhu.png',
'https://cdn.discordapp.com/attachments/735163948781011136/775155178654793758/1604834736777.png',
'https://cdn.discordapp.com/attachments/735163948781011136/774771681242644480/798.png',
'https://cdn.discordapp.com/attachments/735163948781011136/772121531702444042/kokkoro_princess_connect_and_1_more_drawn_by_neps_l__7bfb536f2adfb19183c9f218e1cfb7cc.jpg',
'https://cdn.discordapp.com/attachments/735163948781011136/772121157703958548/karyl_princess_connect_and_1_more_drawn_by_neps_l__34e2dab3fd2b37b565bb5148aab419d5.jpg',
'https://cdn.discordapp.com/attachments/782748631429939212/783534270743707709/EnftOw0VkAMDK8R.png',
'https://cdn.discordapp.com/attachments/735163948781011136/770765386320314428/illust_85275211_20201027_174550.jpg',
'https://cdn.discordapp.com/attachments/782748631429939212/783537848342413312/Ejac2N6VgAAlVK0.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783537778120982529/sample-9aa9660b35fb88761fbc7508473c90b0.png',
'https://cdn.discordapp.com/attachments/461364788560265216/762174988358778900/1601786327587.gif',
'https://cdn.discordapp.com/attachments/461364788560265216/764610789021188106/1602366850152.jpg',
'https://cdn.discordapp.com/attachments/461364788560265216/766526014355669062/karyl_princess_connect_and_1_more_drawn_by_eretto__2f547bc3e4aa5b4ab6f26ebe6b3c16dd.png',
'https://cdn.discordapp.com/attachments/461364788560265216/754907355430518874/1600053885481.png',
'https://cdn.discordapp.com/attachments/782748631429939212/783537227824627742/Eh8dzBGUwAEujCx.png'];

class PresentsEffect {
    ///////////////////////////////////////////
    // "Public" Static methods
    ///////////////////////////////////////////
    static init() {
        PresentsEffect.command = '/presents';
        PresentsEffect.shiz_img = 'https://cdn.discordapp.com/attachments/375406879553093633/659201454497595402/shiz_padoru2.png';
        PresentsEffect.present_img = 'https://cdn.discordapp.com/attachments/782748631429939212/783923289705414666/present-150291_1280-293x300.png';
        PresentsEffect.presents_duration_s = 30;
        PresentsEffect.present_animations = ['type1', 'type2', 'type3', 'type4', 'type5', 'type6']
        PresentsEffect.levels = [
            { spawn_rate: 1000, spawn_limit: 6 },
            { spawn_rate: 1000, spawn_limit: 10 },
        ];

        PresentsEffect.versions = {
            'normal': {
                padoru: PresentsEffect.shiz_img,
                img_bank: [].concat(normal_ecchi_imgs, loli_ecchi_imgs)
            },
        }
        PresentsEffect.state = {
            is_on: false,
            enabled: true,
            timeout: null,
            level: PresentsEffect.levels[0],
            version: PresentsEffect.versions['normal'],
        }
        PresentsEffect.container = document.createElement('div');
        document.documentElement.appendChild(PresentsEffect.container);
    }

    static disable() {
        PresentsEffect.state.enabled = false;
    }

    static enable() {
        PresentsEffect.state.enabled = true;
    }

    static stop() {
        PresentsEffect.state.is_on = false;
    }

    static addElement(element) {
        PresentsEffect.container.appendChild(element);
    }

    static handleCommand(message_parts = [], other_args = {}) {

        // No parse, right now just one version
        // TODO: add different H levels and loli options

        // Disable presents after the timeout. If there is already one, reset the timer
        if (PresentsEffect.state.timeout) {
            clearTimeout(PresentsEffect.state.timeout);
        }
        PresentsEffect.state.timeout =
            setTimeout(PresentsEffect.stop, PresentsEffect.presents_duration_s * 1000);

        // Only start the padoru animation if it is not already started
        if (PresentsEffect.state.is_on) {
            return;
        }
        PresentsEffect.state.is_on = true;
        PresentsEffect._faceAnimation();
        PresentsEffect._runPresentsAnimation();
    }
    ///////////////////////////////////////////
    // Timed Static methods
    ///////////////////////////////////////////
    static _faceAnimation(){
        if (!PresentsEffect.state.is_on) {
            return;
        }
        const face_img = PresentsEffect.state.version.padoru;

        const face_effect = document.createElement('img');
        face_effect.classList.add('c-effect__presents-face-inner');
        face_effect.src = face_img;

        const outer = document.createElement('div');
        outer.classList.add('c-effect__presents-face-outer');

        const fling1 = document.createElement('img')
        fling1.classList.add('c-effect__presents-face-fling');
        fling1.classList.add('c-effect__presents-face-fling-type1');
        fling1.src = PresentsEffect.present_img;

        const fling2 = document.createElement('img')
        fling2.classList.add('c-effect__presents-face-fling');
        fling2.classList.add('c-effect__presents-face-fling-type2');
        fling2.src = PresentsEffect.present_img;

        const fling3 = document.createElement('img')
        fling3.classList.add('c-effect__presents-face-fling');
        fling3.classList.add('c-effect__presents-face-fling-type3');
        fling3.src = PresentsEffect.present_img;
        outer.appendChild(face_effect);
        outer.appendChild(fling1);
        outer.appendChild(fling2);
        outer.appendChild(fling3);
        /*
        const outer1 = document.createElement('div');
        outer1.classList.add('c-effect__presents-face-outer');
        fling1.src = PresentsEffect.present_img;
                                    //outer1.appendChild(fling1);
                                    //PadoruEffect.addElement(outer1);

        const outer2 = document.createElement('div');
        outer2.classList.add('c-effect__presents-face-outer');
        const fling2 = document.createElement('img')
        fling2.classList.add('c-effect__presents-face-fling');
        fling2.classList.add('c-effect__presents-face-fling-type2');
        fling2.src = PresentsEffect.present_img;
//outer2.appendChild(fling2);
//PadoruEffect.addElement(outer2);

        const outer3 = document.createElement('div');
        outer3.classList.add('c-effect__presents-face-outer');
        const fling3 = document.createElement('img')
        fling3.classList.add('c-effect__presents-face-fling');
        fling3.classList.add('c-effect__presents-face-fling-type3');
        fling3.src = PresentsEffect.present_img;
//outer3.appendChild(fling3);
//PadoruEffect.addElement(outer3);

        outer.appendChild(fling1);
        outer.appendChild(fling2);
        outer.appendChild(fling3);
        */

PadoruEffect.addElement(outer);
const fn = () =>{
    face_effect.parentElement.removeChild(face_effect);
    face_effect.parentElement.removeChild(fling1);
    face_effect.parentElement.removeChild(fling2);
    face_effect.parentElement.removeChild(fling3);
    face_effect.removeEventListener('animationend', fn);
}
face_effect.addEventListener('animationend', fn);
}

static _runPresentsAnimation() {
    const create_fn = (is_left) => {
        if (!PresentsEffect.state.is_on) {
            return;
        }

        PresentsEffect._create_present(is_left);
        setTimeout(() => create_fn(!is_left), PresentsEffect.state.level.spawn_rate);
    };
    setTimeout(() => create_fn(true), PresentsEffect.state.level.spawn_rate);
}
static _create_present(is_left){
    if (!PresentsEffect.state.is_on || !PresentsEffect.state.enabled) {
        return;
    }

    //const present_img = PresentsEffect.shiz_img; // replace with random
    const present_img = CustomTextTriggers.randomElement(PresentsEffect.state.version.img_bank);
    const animation = CustomTextTriggers.randomElement(PresentsEffect.present_animations);

    let offset = -500;
    if (is_left) {
        offset = 10;
    }
    else {
        offset = 55;
    }
    let random_location = (Math.random() * 35 + offset).toFixed(4);

    const inner = document.createElement('img')
    inner.classList.add(`c-effect__presents-present-fall`);
    inner.classList.add(`c-effect__presents-present-fall-${animation}`);
    inner.style.left = `${random_location}%`; 
    inner.src = present_img;
    PresentsEffect.addElement(inner);

    const fn = () => {
        inner.parentElement.removeChild(inner);
        inner.removeEventListener('animationend', fn);
    };
    inner.addEventListener('animationend', fn);
}
}
class PadoruEffect {
    ///////////////////////////////////////////
    // Static variables
    ///////////////////////////////////////////


    ///////////////////////////////////////////
        // "Public" Static methods
        ///////////////////////////////////////////
        static init() {
            PadoruEffect.command = '/padoru';
            PadoruEffect.animations = ['type1', 'type2', 'type3', 'type4'];
            PadoruEffect.max_padoru_time_limit_s = 1200;
            PadoruEffect.levels = [
                { spawn_rate: 1000, spawn_limit: 6 },
                { spawn_rate: 1000, spawn_limit: 10 },
            ];
            PadoruEffect.images = [
                // Yue
                'https://cdn.discordapp.com/emojis/655099097237422130.png',
                // Saber
                'https://cdn.discordapp.com/emojis/519149153746550785.png',
                // Chino
                'https://cdn.discordapp.com/attachments/375406879553093633/659064801217085498/chino-padoru.png',
                // Taiga
                'https://cdn.discordapp.com/attachments/466273613092225046/659068018696912906/taiga-padoru.png',
                // Miku
                'https://cdn.discordapp.com/attachments/518340427506647042/659073537809711104/miku-padoru.png',
                // Shizuru
                'https://cdn.discordapp.com/attachments/375406879553093633/659201454497595402/shiz_padoru2.png',
            ];

            PadoruEffect.state = {
                is_on: false,
                enabled: true,
                level_info: PadoruEffect.levels[0],
                timeout: null,
            };
            PadoruEffect.container = document.createElement('div');
            document.documentElement.appendChild(PadoruEffect.container);
        }

    static stop() {
        PadoruEffect.state.is_on = false;
    }

    static disable() {
        PadoruEffect.state.enabled = false;
    }

    static enable() {
        PadoruEffect.state.enabled = true;
    }


    static addElement(element) {
        PadoruEffect.container.appendChild(element);
    }

    static handleCommand(message_parts = [], other_args = {}) { // for compatibility

        let [level, time_limit_s] = PadoruEffect.parseMessage(message_parts)

        // Update the currently used snowing level
        let level_index = level - 1;
        if (level_index < 0 || level_index > PadoruEffect.levels.length) {
            level_index = 0;
        }
        PadoruEffect.state.level_info = PadoruEffect.levels[level_index];

        // Disable padoru after the timeout. If there is already one, reset the timer
        if (PadoruEffect.state.timeout) {
            clearTimeout(PadoruEffect.state.timeout);
        }
        PadoruEffect.state.timeout =
            setTimeout(PadoruEffect.stop, time_limit_s * 1000);

        // Only start the padoru animation if it is not already started
        if (PadoruEffect.state.is_on) {
            return;
        }
        PadoruEffect.state.is_on = true;
        PadoruEffect._runAnimation();
    }

    static parseMessage (message_parts){
        if (message_parts[0] === 'off') {
            PadoruEffect.stop();
            return;
        }

        let level = parseInt(message_parts[0] || '1', 10);
        if (isNaN(level) || level < 1) {
            level = 1;
        }

        let time_limit_s = parseInt(message_parts[1] || '1200', 10);
        if (isNaN(time_limit_s) || time_limit_s < 1) {
            time_limit_s = 10;
        } else if (time_limit_s > PadoruEffect.max_time_limit_s) {
            time_limit_s = PadoruEffect.max_time_limit_s;
        }
        return [level, time_limit_s]
    }

    ///////////////////////////////////////////
    // "Timer" Static methods
    ///////////////////////////////////////////
    static createPadoru() {
        if (!PadoruEffect.state.enabled || !PadoruEffect.state.is_on) {
            return;
        }

        const padoru_image = CustomTextTriggers.randomElement(PadoruEffect.images);
        const animation_type = CustomTextTriggers.randomElement(PadoruEffect.animations);
        const random_percent = (Math.random() * 100).toFixed(4);

        const outer = document.createElement('div');
        outer.classList.add('c-effect__padoru-outer');
        outer.classList.add(animation_type);
        outer.style.left = `${random_percent}%`;

        const shake_container = document.createElement('div');
        shake_container.classList.add('c-effect__padoru-shake');

        const inner = document.createElement('img');
        inner.classList.add('c-effect__padoru');
        inner.src = padoru_image;

        shake_container.appendChild(inner);
        outer.appendChild(shake_container);
        PadoruEffect.addElement(outer);
        const fn = () => {
            outer.parentElement.removeChild(outer);
            outer.removeEventListener('animationend', fn);
        };
        outer.addEventListener('animationend', fn);
    }

    static _runAnimation() {
        const create_fn = () => {
            if (!PadoruEffect.state.is_on) {
                return;
            }

            const max_padoru = PadoruEffect.state.level_info.spawn_limit;
            const total = Math.floor(1 + Math.random() * (max_padoru - 1));
            for (let i = 0; i < total; i++) {
                PadoruEffect.createPadoru();
            }

            setTimeout(create_fn, PadoruEffect.state.level_info.spawn_rate);
        };
        setTimeout(create_fn, PadoruEffect.state.level_info.spawn_rate);
    }

}

class SnowEffect {
    ///////////////////////////////////////////
    // Static variables
    ///////////////////////////////////////////


    ///////////////////////////////////////////
        // "Public" Static methods
        ///////////////////////////////////////////
        static init() {
            SnowEffect.command = '/snow';
            SnowEffect.templates = ['', ''];
            SnowEffect.animations = ['type1', 'type2', 'type3', 'type4'];
            SnowEffect.levels = [
                { spawn_rate: 250, spawn_limit: 10 },
                { spawn_rate: 250, spawn_limit: 20 },
                { spawn_rate: 150, spawn_limit: 20 },
                { spawn_rate: 75, spawn_limit: 20 },
            ];
            SnowEffect.max_time_limit_s = 1200;
            SnowEffect.state = {
                is_on: false,
                enabled: true,
                level_info: SnowEffect.levels[0],
                timeout: null,
            }
            SnowEffect.container = document.createElement('div');
            document.documentElement.appendChild(SnowEffect.container);
        }
    static stop() {
        SnowEffect.state.is_on = false;
    }
    static disable() {
        SnowEffect.state.enabled = false;
    }
    static enable() {
        SnowEffect.state.enabled = true;
    }
    static handleCommand(message_parts = [], other_args = {}) { // other args is for compatability
        let [level, time_limit_s] = SnowEffect.parseMessage(message_parts);

        // Update the currently used snowing level
        let level_index = level - 1;
        if (level_index < 0 || level_index > SnowEffect.levels.length) {
            level_index = 0;
        }
        SnowEffect.state.level_info = SnowEffect.levels[level_index];

        // Disable snow after the timeout. If there is already one, reset the timer
        if (SnowEffect.state.timeout) {
            clearTimeout(SnowEffect.state.timeout);
        }
        SnowEffect.state.timeout =
            setTimeout(SnowEffect.stop, time_limit_s * 1000);

        // Only start the snow animation if it is not already started
        if (SnowEffect.state.is_on) {
            return;
        }
        SnowEffect.state.is_on = true;
        SnowEffect._runAnimation();
    }
    static addElement(element) {
        SnowEffect.container.appendChild(element);
    }

    static parseMessage(message_parts) {
        if (message_parts[0] === 'off') {
            SnowEffect.stop();
            return;
        }

        let level = parseInt(message_parts[0] || '1', 10);
        if (isNaN(level) || level < 1) {
            level = 1;
        }

        let time_limit_s = parseInt(message_parts[1] || '1200', 10);
        if (isNaN(time_limit_s) || time_limit_s < 1) {
            time_limit_s = 10;
        } else if (time_limit_s > SnowEffect.max_time_limit_s) {
            time_limit_s = SnowEffect.max_time_limit_s;
        }

        return [level, time_limit_s];

    }

    ///////////////////////////////////////////
    // "Timer" Static methods
    ///////////////////////////////////////////
    static createSnowflake() {
        if (!SnowEffect.state.is_on || !SnowEffect.state.enabled) {
            return;
        }

        const ascii = CustomTextTriggers.randomElement(SnowEffect.templates);
        const animation_type = CustomTextTriggers.randomElement(SnowEffect.animations);
        const random_percent = (Math.random() * 100).toFixed(4);

        const outer = document.createElement('div');
        outer.classList.add('c-effect__snowflake-outer');
        outer.style.left = `${random_percent}%`;

        const inner = document.createElement('div');
        inner.classList.add('c-effect__snowflake');
        inner.classList.add(animation_type);
        inner.textContent = ascii;

        outer.appendChild(inner);
        SnowEffect.addElement(outer);
        const fn = () => {
            outer.parentElement.removeChild(outer);
            outer.removeEventListener('animationend', fn);
        };
        outer.addEventListener('animationend', fn);
    }

    static _runAnimation() {
        const create_fn = () => {
            if (!SnowEffect.state.is_on) {
                return;
            }

            const max_snowflakes = SnowEffect.state.level_info.spawn_limit;
            const total = Math.floor(1 + Math.random() * (max_snowflakes - 1));
            for (let i = 0; i < total; i++) {
                SnowEffect.createSnowflake();
            }

            setTimeout(create_fn, SnowEffect.state.level_info.spawn_rate);
        };
        setTimeout(create_fn, SnowEffect.state.level_info.spawn_rate);
    }
}

class ErabeEffect {

    ///////////////////////////////////////////
    // Static variables
    /////////////////////////////////////////// 

    ///////////////////////////////////////////
        // "Public" Static methods
        ///////////////////////////////////////////
        static init() {

            ErabeEffect.command = '/erabe';
            ErabeEffect.max_time_limit_s = 20;
            ErabeEffect.max_spawn_count = 15;
            ErabeEffect.max_poll_options = 10;
            ErabeEffect.state = {
                is_on: false,
                enabled: true,
                timeout: null,
            }
            ErabeEffect.container = document.createElement('div');
            document.documentElement.appendChild(ErabeEffect.container);
        };
    static addElement(element) {
        ErabeEffect.container.appendChild(element);
    }
    static handleCommand(message_parts = [], other_args = {}){

        let did_send_the_message = other_args.did_send_the_message;

        let [spawn_count, time_limit_s, total_erabe_poll_options] =
            ErabeEffect.parseMessage(message_parts);

        if (ErabeEffect.state.is_on) {
            return;
        }
        ErabeEffect.state.is_on = true;

        if (did_send_the_message) {
            try {
                const options = [];
                for (let i = 1; i <= total_erabe_poll_options; i++) {
                    options.push(i.toString());
                }

                socket.emit('newPoll', {
                    title:"ERABE",
                    opts: options,
                    obscured:false,
                });
            } catch (e) {}
        }

        for (let i = 0; i < spawn_count; i++) {
            ErabeEffect.createErabe();
        }

        // Remove all erabes after the timeout
        if (ErabeEffect.state.timeout) {
            clearTimeout(ErabeEffect.state.timeout);
        }
        ErabeEffect.state.timeout =
            setTimeout(ErabeEffect.stop, time_limit_s * 1000);
    }
    static stop() {
        ErabeEffect.state.is_on = false;
        if (ErabeEffect.state.timeout) {
            clearTimeout(ErabeEffect.state.timeout);
        }

        ErabeEffect.state.timeout = null;
    }
    static disable() {
        ErabeEffect.state.enabled = false;
    }
    static enable() {
        ErabeEffect.state.enabled = true;
    }
    ///////////////////////////////////////////
    // "Private" Static methods
    ///////////////////////////////////////////
    static parseMessage(message_parts) {
        if (message_parts[0] === 'off') {
            ErabeEffect.stop();
            return;
        }

        let spawn_count = parseInt(message_parts[0] || '2', 10);
        if (isNaN(spawn_count) || spawn_count < 1) {
            spawn_count = 2;
        } else if (spawn_count > ErabeEffect.max_spawn_count) {
            spawn_count = ErabeEffect.max_spawn_count;
        }

        let time_limit_s = parseInt(message_parts[1] || '10', 10);
        if (isNaN(time_limit_s) || time_limit_s < 1) {
            time_limit_s = 10;
        } else if (time_limit_s > ErabeEffect.max_time_limit_s) {
            time_limit_s = ErabeEffect.max_time_limit_s;
        }

        let total_erabe_poll_options = parseInt(message_parts[2] || '2', 10);
        if (isNaN(total_erabe_poll_options) || total_erabe_poll_options < 1) {
            total_erabe_poll_options = 2;
        } else if (total_erabe_poll_options > ErabeEffect.max_poll_options) {
            total_erabe_poll_options = ErabeEffect.max_poll_options;
        }
        return [spawn_count, time_limit_s, total_erabe_poll_options];
    }
    static createErabe() {
        if (!ErabeEffect.state.enabled || !ErabeEffect.state.is_on) {
            return;
        }

        // Build the erabe element
        const element = document.createElement('div');
        element.classList.add('c-effect_erabe', 'js-effect-erabe');
        element.textContent = 'erabe';

        // Randomizes the location of the erabe div
        const randomizePosition = () => {
            const [x, y] = ErabeEffect.getRandomErabePosition(
                element.offsetWidth,
                element.offsetHeight,
                50);

            element.style.left = `${x}px`;
            element.style.top = `${y}px`;
        };
        randomizePosition();

        const fn = () => {
            if (!ErabeEffect.state.is_on) {
                element.parentElement.removeChild(element);
                element.removeEventListener('animationiteration', fn);
                return;
            }

            randomizePosition();
        };
        element.addEventListener('animationiteration', fn);

        ErabeEffect.addElement(element);
    }
    static getRandomErabePosition(div_width, div_height, buffer) {
        const width = window.innerWidth - div_width;
        const height = window.innerHeight - div_height;

        const random_x = Math.floor(Math.random() * width);
        const random_y = Math.floor(Math.random() * height);
        return [random_x, random_y];
    }

}
/**
 * To add a new effect create a class like so:

class YourNewEffect {
    static command = '/your-command';
    constructor() {}

    init() {}

    handleCommand(message_parts = [], other_args = {}) {}

    enable() {}
    disable() {}
    stop() {}
}
Then add it to the `effects` static variable below
*/
class CustomTextTriggers {



    static init() {
        // Only place you need to add a new effect to make it work
        CustomTextTriggers.effects = [ErabeEffect, /*SnowEffect, */PadoruEffect, PresentsEffect];
        if (CustomTextTriggers.has_init) {
            return;
        }
        CustomTextTriggers.has_init = false;

        // Setup the effect lookup
        CustomTextTriggers.effect_lookup = new Map();
        for (let effect_cls of CustomTextTriggers.effects) {
            effect_cls.init();
            CustomTextTriggers.effect_lookup.set(effect_cls.command, 
                {effect: effect_cls, handle: effect_cls.handleCommand});
        }

        // TODO make this "/effects arg" with some kind of handler?
        // Add non-effect commands here
        CustomTextTriggers.effect_lookup.set('/effects_disable', 
            {effect: null, handle: CustomTextTriggers.disableEffects});
        CustomTextTriggers.effect_lookup.set('/effects_enable', 
            {effect: null, handle: CustomTextTriggers.enableEffects});
        CustomTextTriggers.effect_lookup.set('/effects_stop', 
            {effect: null, handle: CustomTextTriggers.stopEffects});

        // testing
        //CustomTextTriggers.effect_lookup.get('/padoru').handle([], {});

    }

    static isMod(username) {
        try {
            let is_mod = false;
            $("#userlist").find('span[class$=userlist_owner],span[class$=userlist_siteadmin]').each(function() {
                if ($(this).text() === username) {
                    is_mod = true;
                    return false;
                }
            });

            return is_mod;
        } catch (e) { return false; }
    }

    static isFirstMod() {
        const first_mod_element = $("#userlist").find('span[class$=userlist_owner],span[class$=userlist_siteadmin]').first();
        if (!first_mod_element) {
            return false;
        }

        return first_mod_element.text() === CLIENT.name;
    }

    static randomElement(array) {
        return array[Math.floor(Math.random() * array.length)];
    }

    /* Command handlers */
    static handleChatMessage(msg_data) {
        const is_shadowed = msg_data.username === CLIENT.name && msg_data.meta.shadow;
        if (msg_data.username === "[server]" || is_shadowed) {
            return;
        }

        if (!CustomTextTriggers.isMod(msg_data.username)) {
            return;
        }

        // If this client was the one who sent the message
        const did_send_the_message = CLIENT.name === msg_data.username;

        const message_parts = msg_data.msg.trim().toLowerCase().replace(/\s\s+/igm, ' ').split(' ');
        if (message_parts.length <= 0 || !message_parts[0]) {
            return;
        }

        const [effect_name, ...effect_args] = message_parts;
        if (effect_name[0] !== '/') {
            return;
        }

        // Build dict for any other arguments we should send
        // This should be a dict to provide these somewhat explicitly, but support addition
        // of future arguements without us having to modify old effect code
        let other_args = {
            'did_send_the_message': did_send_the_message,
        };

        // Get the command and handle command if valid
        let command_class = CustomTextTriggers.effect_lookup.get(effect_name);
        if (command_class !== undefined) {
            command_class.handle(effect_args, other_args);
        }
    }

    static disableEffects() {
        for (let effect of CustomTextTriggers.effects) {
            effect.disable()
        }
    }

    static enableEffects() {
        for (let effect of CustomTextTriggers.effects) {
            effect.enable()
        }
    }

    static stopEffects() {
        for (let effect of CustomTextTriggers.effects) {
            effect.stop()
        }
    }
}


CustomTextTriggers.init();

$('<button id="effectsbtn" class="btn btn-sm ' + (EFFECTSOFF ? 'btn-danger' : 'btn-default') + '" title="Toggle effects">Effects ' + (EFFECTSOFF ? 'OFF' : 'ON') + '</button>')
    .appendTo("#chatwrap")
    .on("click", function() {
        EFFECTSOFF = !EFFECTSOFF;
        setOpt(CHANNEL.name + "_EFFECTSOFF", EFFECTSOFF);
        if (EFFECTSOFF) {
            this.className = "btn btn-sm btn-danger";
            this.textContent = "Effects OFF";
            CustomTextTriggers.disableEffects();
        } else {
            this.className = "btn btn-sm btn-default";
            this.textContent = "Effects ON";

            CustomTextTriggers.enableEffects();
        }
    });

//checkEffects();

// This is what turns the whole thing on to be run by chat messages like /erabe
// TODO: Should we hide this behind a button being enabled? Like niconico is?
socket.on("chatMsg", CustomTextTriggers.handleChatMessage);
